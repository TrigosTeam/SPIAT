<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SPIAT">
<title>Overview of the SPIAT package • SPIAT</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Overview of the SPIAT package">
<meta property="og:description" content="SPIAT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SPIAT</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Overview of the SPIAT package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cancer-evolution/SPIAT/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="introduction_files/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="introduction_files/plotly-binding-4.10.0/plotly.js"></script><script src="introduction_files/typedarray-0.1/typedarray.min.js"></script><link href="introduction_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="introduction_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="introduction_files/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="introduction_files/plotly-main-2.5.1/plotly-latest.min.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Overview of the SPIAT package</h1>
                        <h4 data-toc-skip class="author">Anna Trigos, Yuzhou Feng, Tom Yang, Mabel Li, John Zhu, Volkan Ozcoban, Maria Doyle</h4>
            
            <h4 data-toc-skip class="date">18 March 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cancer-evolution/SPIAT/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="material-under-development">MATERIAL UNDER DEVELOPMENT<a class="anchor" aria-label="anchor" href="#material-under-development"></a>
</h2>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>SPIAT (<strong>Sp</strong>atial <strong>I</strong>mage <strong>A</strong>nalysis of <strong>T</strong>issues) is an R package with a suite of data processing, quality control, visualization, data handling and data analysis tools <span class="citation">(Yang et al. 2020)</span>. SPIAT is directly compatible with Opal multiplex immunohistochemistry images analysed through the HALO and InForm analysis software, but its intuitive implementation allows use with a diversity of platforms.</p>
<p>The Opal multiplex immunohistochemistry staining protocol enables 6-8 tissue markers to be used simultaneously on a single slide. It is suitable for use with formalin fixed paraffin embedded (FFPE) tissue sections, so it is also of relevance for clinical practice. The fluorescence of each marker is measured through imaging, and each cell is assigned an X,Y coordinate of its location. In effect this provides single-cell resolution. The fluorescence intensity of individual markers are then combined to identify the phenotype of the cells in the tissue.</p>
<p>SPIAT includes novel algorithms for the identification of cell clusters, cell margins and cell gradients, the calculation of neighbourhood proportions, and algorithms for the prediction of cell phenotypes in tissue images. SPIAT also includes speedy implementations of the calculation of cell distances and detection of cell communities. An overview of the functions available is shown in the figure below.</p>
<p><img src="../inst/articles/package_diagram_2021.png" width="2000" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="setting-up-the-data">Setting up the data<a class="anchor" aria-label="anchor" href="#setting-up-the-data"></a>
</h2>
<p>First we load the SPIAT library.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPIAT</span><span class="op">)</span></code></pre></div>
<p>We can use <code>format_image_to_sce</code> to read in and format raw data for SPIAT.<code>format_image_to_sce</code> creates a SingleCellExperiment object. It requires at least 4 arguments:</p>
<ul>
<li>
<code>format</code>: “INFORM,” “HALO,” “Visium,” “CODEX” “cellprolifer, or”general"</li>
<li>
<code>image</code>: path to the raw InForm or HALO image data file</li>
<li>
<code>markers</code>: names of markers used in the OPAL staining. These must be in the same order as the marker columns in the input file, and for InForm must match the marker name used in the input file. One of the markers must be DAPI.</li>
<li>
<code>locations</code>: locations of the markers, either Nucleus, Cytoplasm or Membrane. These must be in the order of the markers. The locations are used to auto-detect the intensity (and dye) columns. Alternatively, the column names can be specified, see below for more information.</li>
</ul>
<div class="section level3">
<h3 id="simple-import">Simple import<a class="anchor" aria-label="anchor" href="#simple-import"></a>
</h3>
<p>The simplest way to read in both InForm and HALO files, is to specify the locations of the markers as shown below. This will automatically detect the appropriate intensity (and dye) columns to use. Here we use a tiny InForm file that’s part of the SPIAT package for <code>raw_inform_data</code> but you would replace <code>system.file</code> with <code>/path/to/your/input/file</code>. The tiny file is just for demonstrating importing a raw data file, later in the <a href="#example-data">Example data</a> section we load a larger preformatted dataset. For information on the InForm and HALO formats see below. For “Visium,” “CODEX” or “cellprolifer see the help (<code><a href="../reference/format_image_to_sce.html">?format_image_to_sce</a></code>). Format”general" allows you to input a matrix of intensities (<code>intensity_matrix</code>), and a vector of <code>phenotypes</code>, cell phenotypes in the same order in which they appear in intensity_matrix. They should be of the form “CD3,CD8,” as opposed to cell names (e.g. “cytotoxic T cells”), as it does some matching with the marker names. If no phenotypes are available, then a vector of NA can be used as input. For general format, you also need to provide a vector with the X coordinates of the cells and one with the Y (<code>coord_x</code> and <code>coord_y</code>). The cells must be in the same order as in the intensity_matrix. If you have Xmin and Xmax columns (and Ymin, Ymax) you can calculate the average and input that.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nucleus"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Membrane"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span><span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          path<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          locations<span class="op">=</span><span class="va">locations</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inform-input">InForm input<a class="anchor" aria-label="anchor" href="#inform-input"></a>
</h3>
<div class="section level5">
<h5 id="intensity-columns">Intensity columns<a class="anchor" aria-label="anchor" href="#intensity-columns"></a>
</h5>
<p>If for some reason you don’t want to specify the <code>locations</code>, you can specify the intensity columns with <code>intensity_columns_interest</code> as shown below. This will give the same result as specifying the locations above.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="st">"Nucleus DAPI (DAPI) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD3 (Opal 520) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Membrane PDL-1 (Opal 540) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD4 (Opal 620) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD8 (Opal 650) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Cytoplasm AMACR (Opal 690) Mean (Normalized Counts, Total Weighting)"</span>
  <span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          path<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                    intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="x-and-y-location-columns">X and Y location columns<a class="anchor" aria-label="anchor" href="#x-and-y-location-columns"></a>
</h5>
<p><code>format_image_to_sce</code> uses the Cell X Position and Cell Y Position columns in the InForm raw data.</p>
</div>
<div class="section level5">
<h5 id="phenotype-column">Phenotype column<a class="anchor" aria-label="anchor" href="#phenotype-column"></a>
</h5>
<p><code>format_image_to_sce</code> uses the Phenotype column in the InForm raw data. The phenotype of a cell can be a single marker, for example, “CD3” (T cell), or a combination of markers, such as “CD3,CD4” (helper T cell). “OTHER” means a cell was positive for DAPI but no other marker. The phenotypes must be based on the markers (e.g. CD3,CD4), rather than names of cells (e.g. cytotoxic T cells). The names of the cells can be added later using the <code>define_celltypes</code> function.</p>
</div>
<div class="section level5">
<h5 id="cell-properties-columns">Cell properties columns<a class="anchor" aria-label="anchor" href="#cell-properties-columns"></a>
</h5>
<p>The following cell properties columns are required to be present in the InForm input file: Entire Cell Area (pixels), Nucleus Area (pixels), Nucleus Compactness, Nucleus Axis Ratio, and Entire Cell Axis Ratio.</p>
</div>
</div>
<div class="section level3">
<h3 id="halo-input">HALO input<a class="anchor" aria-label="anchor" href="#halo-input"></a>
</h3>
<div class="section level5">
<h5 id="intensity-columns-1">Intensity columns<a class="anchor" aria-label="anchor" href="#intensity-columns-1"></a>
</h5>
<p>For HALO you can also just specify the <code>locations</code> to auto-detect the columns as shown above. But if you want to specify the columns instead, you can do so with <code>intensity_columns_interest</code>, as shown in the example below. Note that then you also must specify the <code>dye_columns_interest</code>.</p>
</div>
<div class="section level5">
<h5 id="dye-columns">Dye columns<a class="anchor" aria-label="anchor" href="#dye-columns"></a>
</h5>
<p><code>format_image_to_sce</code> requires the HALO dye columns to assign the phenotype. If not using <code>locations</code> to auto-detect, these can be specified with <code>dye_columns_interest</code>. These columns have the marker status (1 or 0 for whether the cell is positive or negative for the marker) and these are used to create the phenotype column. For example, if HALO has assigned a cell a marker status of 1 for CD3 and 1 for CD4, SPIAT will give it the Phenotype “CD3,CD4.” Cells that have a marker status of 1 for DAPI and no other marker, are given the phenotype “OTHER.”</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_halo_data</span> <span class="op">&lt;-</span> <span class="st">"path/to/halo/file"</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dye 1 Nucleus Intensity"</span>,
                                <span class="st">"Dye 2 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 3 Membrane Intensity"</span>,
                                <span class="st">"Dye 4 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 5 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 6 Cytoplasm Intensity"</span><span class="op">)</span>
<span class="va">dye_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dye 1 Positive Nucleus"</span>,
                          <span class="st">"Dye 2 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 3 Positive Membrane"</span>,
                          <span class="st">"Dye 4 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 5 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 6 Positive Cytoplasm"</span><span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"HALO"</span>,
                          path<span class="op">=</span><span class="va">raw_halo_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span>,
                          dye_columns_interest<span class="op">=</span><span class="va">dye_columns_interest</span>
                          <span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="x-and-y-location-columns-1">X and Y location columns<a class="anchor" aria-label="anchor" href="#x-and-y-location-columns-1"></a>
</h5>
<p><code>format_image_to_sce</code> takes the average of the HALO X min and X max columns for each cell to create the Cell.X.Position column. It takes the average of the Y min and Y max to create the Cell.Y.Position column.</p>
</div>
<div class="section level5">
<h5 id="phenotype-column-1">Phenotype column<a class="anchor" aria-label="anchor" href="#phenotype-column-1"></a>
</h5>
<p><code>format_image_to_sce</code> creates the Phenotype column from the dye columns as described under the Dye columns section above.</p>
</div>
<div class="section level5">
<h5 id="cell-properties-columns-1">Cell properties columns<a class="anchor" aria-label="anchor" href="#cell-properties-columns-1"></a>
</h5>
<p>The following cell properties columns are required to be present in the HALO input file: Cell Area, Nucleus Area, Cytoplasm Area.</p>
</div>
</div>
<div class="section level3">
<h3 id="splitting-images">Splitting images<a class="anchor" aria-label="anchor" href="#splitting-images"></a>
</h3>
<p>In the case of large images, or images where there are two independent tissue sections, it is recommended to split images into sections defined by the user. This can be performed with <code>image_splitter</code> after <code>format_image_to_sce</code>. It can also plot the different combinations of markers within the image segments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/image_splitter.html">image_splitter</a></span><span class="op">(</span><span class="va">formatted_image</span>, number_of_splits<span class="op">=</span><span class="fl">3</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-data">Example data<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h3>
<p>In this vignette we will use an InForm data file that’s already been formatted for SPIAT with <code>format_image_to_sce</code>, which we can load with <code>data</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"simulated_image"</span><span class="op">)</span></code></pre></div>
<p>This is <em>SingleCellExperiment</em> format.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "SingleCellExperiment"</span>
<span class="co">## attr(,"package")</span>
<span class="co">## [1] "SingleCellExperiment"</span></code></pre>
<p>This example data has 6 markers and 8419 cells.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1]    5 4951</span></code></pre>
<p><code>assay</code> stores the intensity level of every marker (rows) for every cell (columns).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 columns</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">##                      Cell_1       Cell_2      Cell_3       Cell_4       Cell_5</span>
<span class="co">## Tumour_marker  4.466925e-01 1.196802e-04 0.235435887 1.125552e-01 1.600443e-02</span>
<span class="co">## Immune_marker1 1.143640e-05 4.360881e-19 0.120582510 2.031554e-13 1.685832e-01</span>
<span class="co">## Immune_marker2 1.311175e-15 5.678623e-02 0.115769761 5.840184e-12 9.025254e-05</span>
<span class="co">## Immune_marker3 6.342341e-09 2.862823e-06 0.053107792 6.289501e-04 4.912962e-13</span>
<span class="co">## Immune_marker4 2.543406e-04 4.702311e-04 0.005878394 4.582812e-03 2.470984e-03</span></code></pre>
<p><code>colData</code> stores the phenotype, x and y coordinates, and the cell properties.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 rows</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></code></pre></div>
<pre><code><span class="co">## DataFrame with 5 rows and 3 columns</span>
<span class="co">##          Phenotype Cell.X.Position Cell.Y.Position</span>
<span class="co">##        &lt;character&gt;       &lt;numeric&gt;       &lt;numeric&gt;</span>
<span class="co">## Cell_1       OTHER        139.7748         86.7041</span>
<span class="co">## Cell_2       OTHER         77.8672         80.0965</span>
<span class="co">## Cell_3       OTHER         84.4463         19.2386</span>
<span class="co">## Cell_4       OTHER        110.1986          5.6560</span>
<span class="co">## Cell_5       OTHER        167.8956        171.9264</span></code></pre>
<p>We can check what phenotypes are present with <code>print_feature</code>, which will print any specified column in the data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">simulated_image</span>, feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "OTHER"                                       </span>
<span class="co">## [2] "Immune_marker1,Immune_marker2"               </span>
<span class="co">## [3] "Tumour_marker"                               </span>
<span class="co">## [4] "Immune_marker1,Immune_marker2,Immune_marker4"</span>
<span class="co">## [5] "Immune_marker1,Immune_marker3"</span></code></pre>
<p>The phenotypes in this example data can be interpreted as follows:</p>
<ul>
<li>Tumour_marker = cancer cells<br>
</li>
<li>Immune_marker1,Immune_marker2 = immune cells 1</li>
<li>Immune_marker1,Immune_marker3 = immune cells 2</li>
<li>Immune_marker1,Immune_marker2,Immune_marker4 = immune cells 3</li>
<li>OTHER = other cell types</li>
</ul>
<p>Tumour_marker identifies which cells in the image are prostate cancer cells. The combination of Immune_marker1, Immune_marker2, Immune_marker3, and Immune_marker4 determine which types of T cells (immune cells) are present.</p>
</div>
</div>
<div class="section level2">
<h2 id="predicting-cell-phenotypes">Predicting cell phenotypes<a class="anchor" aria-label="anchor" href="#predicting-cell-phenotypes"></a>
</h2>
<p>SPIAT can predict cell phenotypes using the marker intensity levels with <code>predict_phenotypes</code>. This can be used to check the phenotypes that have been assigned by InForm and HALO. It can also potentially be used to automate the manual phenotypying performed with InForm/HALO. <code>predict_phenotypes</code> produces a density plot that shows the cutoff for calling a cell positive for a marker. It also prints to the console the number of true positives (TP), true negatives (TN), false positives (FP) and false negatives (FN). It returns a table containing the phenotypes predicted by SPIAT and the actual phenotypes from InForm/HALO. This can help show if we need to go back to Inform or HALO to refine the phenotyping. If you don’t have a <code>tumour_marker</code> you can use a marker that is present in many cells, that has at least one peak more than the main marker peak, a background peak, required by the algorithm. Of note, this algorithm does not take into account cell shape or size, so if these are required for phenotyping, manual phenotyping with HALO or InForm is recommended.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_phenotypes.html">predict_phenotypes</a></span><span class="op">(</span>sce_object <span class="op">=</span> <span class="va">simulated_image</span>,
                                      thresholds <span class="op">=</span> <span class="cn">NULL</span>,
                                      tumour_marker <span class="op">=</span> <span class="st">"Tumour_marker"</span>,
                                      baseline_markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune_marker1"</span>, <span class="st">"Immune_marker2"</span>, <span class="st">"Immune_marker3"</span>, <span class="st">"Immune_marker4"</span><span class="op">)</span>,
                                      reference_phenotypes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Tumour_marker"</span>
<span class="co">## [1] "For Tumour_marker:"</span>
<span class="co">## [1] "TP:819 TN:3781 FP:351 FN:0"</span>
<span class="co">## [1] "Tumour_marker  threshold intensity:  0.445450443784465"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker1"</span>
<span class="co">## [1] "For Immune_marker1:"</span>
<span class="co">## [1] "TP:1146 TN:3620 FP:185 FN:0"</span>
<span class="co">## [1] "Immune_marker1  threshold intensity:  0.116980867970434"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker2"</span>
<span class="co">## [1] "For Immune_marker2:"</span>
<span class="co">## [1] "TP:968 TN:3823 FP:160 FN:0"</span>
<span class="co">## [1] "Immune_marker2  threshold intensity:  0.124283809517202"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-3.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker3"</span>
<span class="co">## [1] "For Immune_marker3:"</span>
<span class="co">## [1] "TP:178 TN:4028 FP:745 FN:0"</span>
<span class="co">## [1] "Immune_marker3  threshold intensity:  0.0166413130263845"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-4.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker4"</span>
<span class="co">## [1] "For Immune_marker4:"</span>
<span class="co">## [1] "TP:630 TN:4301 FP:20 FN:0"</span>
<span class="co">## [1] "Immune_marker4  threshold intensity:  0.00989731350898589"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-13-5.png" width="700"></p>
<p>We can use <code>marker_prediction_plot</code> to plot the predicted cell phenotypes and the ones obtained using HALO or InForm, for comparison.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_prediction_plot.html">marker_prediction_plot</a></span><span class="op">(</span><span class="va">predicted_image</span>, marker<span class="op">=</span><span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; = "none")` instead.</span>
<span class="co">## `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; = "none")` instead.</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>The plot shows Immune_marker1+ cells in the tissue. On the left are the Immune_marker1+ cells defined by InForm and on the right are the Immune_marker1+ cells predicted using SPIAT.</p>
<p>Similar plots are generated for other markers. For example, the following plots are for Tumour_marker.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_prediction_plot.html">marker_prediction_plot</a></span><span class="op">(</span><span class="va">predicted_image</span>, marker<span class="op">=</span><span class="st">"Tumour_marker"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; = "none")` instead.</span>
<span class="co">## `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; = "none")` instead.</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-15-1.png" width="700"> Use the predicted phenotypes to replace the original ones.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_phenotypes.html">predict_phenotypes</a></span><span class="op">(</span>sce_object <span class="op">=</span> <span class="va">simulated_image</span>,
                                      thresholds <span class="op">=</span> <span class="cn">NULL</span>,
                                      tumour_marker <span class="op">=</span> <span class="st">"Tumour_marker"</span>,
                                      baseline_markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune_marker1"</span>, <span class="st">"Immune_marker2"</span>, <span class="st">"Immune_marker3"</span>, <span class="st">"Immune_marker4"</span><span class="op">)</span>,
                                      reference_phenotypes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Tumour_marker  threshold intensity:  0.445450443784465"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker1  threshold intensity:  0.116980867970434"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-2.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker2  threshold intensity:  0.124283809517202"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-3.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker3  threshold intensity:  0.0166413130263845"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-4.png" width="700"></p>
<pre><code><span class="co">## [1] "Immune_marker4  threshold intensity:  0.00989731350898589"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-5.png" width="700"></p>
<p>Define the predicted image and apply tSNE dimensionality reduction plot for the predicted image.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_celltypes.html">define_celltypes</a></span><span class="op">(</span><span class="va">predicted_image2</span>, 
                                    categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>, <span class="st">"Immune_marker1,Immune_marker3"</span>, 
                                                   <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span>, <span class="st">"OTHER"</span><span class="op">)</span>, 
                                    category_colname <span class="op">=</span> <span class="st">"Phenotype"</span>,
                                    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>, 
                                              <span class="st">"Immune3"</span>, <span class="st">"Others"</span><span class="op">)</span>,
                                    new_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="fu"><a href="../reference/dimensionality_reduction_plot.html">dimensionality_reduction_plot</a></span><span class="op">(</span><span class="va">predicted_image2</span>, plot_type <span class="op">=</span> <span class="st">"TSNE"</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="section level3">
<h3 id="specifying-cell-types">Specifying cell types<a class="anchor" aria-label="anchor" href="#specifying-cell-types"></a>
</h3>
<p>Specifying each Phenotype can be tedious if the Phenotype consists of multiple markers. To make it easier, SPIAT <code>define_celltypes</code> can be used to add a column indicating the cell type. By default the column is called Cell.Type. The difference between Phenotype and Cell.Type is that phenotype represents all the markers present on the cell but Cell.Type is the identity of the cell.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_celltypes.html">define_celltypes</a></span><span class="op">(</span><span class="va">simulated_image</span>, 
                                    categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>, <span class="st">"Immune_marker1,Immune_marker3"</span>, 
                                                   <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span>, <span class="st">"OTHER"</span><span class="op">)</span>, 
                                    category_colname <span class="op">=</span> <span class="st">"Phenotype"</span>,
                                    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>, 
                                              <span class="st">"Immune3"</span>, <span class="st">"Others"</span><span class="op">)</span>,
                                    new_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="quality-control">Quality control<a class="anchor" aria-label="anchor" href="#quality-control"></a>
</h2>
<div class="section level3">
<h3 id="boxplots-of-marker-intensity">Boxplots of marker intensity<a class="anchor" aria-label="anchor" href="#boxplots-of-marker-intensity"></a>
</h3>
<p>Incorrect or unreliable phenotyping of cells may also be identified through comparing the marker level for cells labelled positive and negative for a marker. Cells positive for a marker should have high levels of the marker. An unclear separation of marker intensities between positive and negative cells would suggest phenotypes have not been accurately assigned. We can use <code>marker_intensity_boxplot</code> to produce a boxplot for cells phenotyped as being positive or negative for a marker.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_intensity_boxplot.html">marker_intensity_boxplot</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Note that some negative cells will have high marker intensity, and vice versa. This is because HALO and InForm use machine learning to determine positive cells, and not a strict threshold, and also take into account properties such as cell shape, nucleus size etc. .</p>
</div>
<div class="section level3">
<h3 id="scatter-plots-of-marker-level">Scatter plots of marker level<a class="anchor" aria-label="anchor" href="#scatter-plots-of-marker-level"></a>
</h3>
<p>Uneven marker staining or high background intensity can be identified with <code>plot_cell_marker_levels</code>. This produces a scatter plot of the intensity of a marker in each cell. Cells that were not phenotyped as being positive for the particular marker are excluded.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_marker_levels.html">plot_cell_marker_levels</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="heatmaps-of-marker-level">Heatmaps of marker level<a class="anchor" aria-label="anchor" href="#heatmaps-of-marker-level"></a>
</h3>
<p>For large images, there is also the option of ‘blurring’ the image, where the image is split into multiple small areas, and marker intensities are averaged within each. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_marker_level_heatmap.html">plot_marker_level_heatmap</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits <span class="op">=</span> <span class="fl">100</span>, <span class="st">"Tumour_marker"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-21-1.png" width="700"> ## Identifying incorrect phenotypes</p>
<p>We may see incorrect phenotypes present in the input data. For example, cells might be incorrectly assigned a phenotype such as “Tumour_marker,Immune_marker1,” both a tumour cell (Tumour_marker) and an immune cell phenotype (Immune_marker1), which is biologically implausible. Incorrect cell phenotypes may be present due to low cell segmentation quality, antibody ‘bleeding’ from one cell to another or inadequate marker thresholding.</p>
<p>We can use <code>marker_permutation</code> to help identify if incorrect cell phenotypes are present. This permutes the marker labels of cells to create a null distribution, and then calculates the empirical p-value of whether an image is enriched or depleted in a particular combination of markers. A low P value for Depletion.p suggests the phenotype is unreliable. However, it is not absolute and it is recommended to review the results.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># permute marker labels of cells</span>
<span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marker_permutation.html">marker_permutation</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_iter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="co"># sort by Observed_cell_number</span>
<span class="va">sig.sorted</span> <span class="op">&lt;-</span> <span class="va">sig</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">sig</span><span class="op">$</span><span class="va">Observed_cell_number</span><span class="op">)</span>, <span class="op">]</span>

<span class="co"># take a look</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sig.sorted</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##                                              Observed_cell_number</span>
<span class="co">## Tumour_marker                                                 819</span>
<span class="co">## Immune_marker1,Immune_marker2,Immune_marker4                  630</span>
<span class="co">## Immune_marker1,Immune_marker2                                 338</span>
<span class="co">## Immune_marker1,Immune_marker3                                 178</span>
<span class="co">## Immune_marker1                                                  0</span>
<span class="co">## Immune_marker2                                                  0</span>
<span class="co">##                                              Percentage_of_iterations_where_present</span>
<span class="co">## Tumour_marker                                                                   100</span>
<span class="co">## Immune_marker1,Immune_marker2,Immune_marker4                                    100</span>
<span class="co">## Immune_marker1,Immune_marker2                                                   100</span>
<span class="co">## Immune_marker1,Immune_marker3                                                   100</span>
<span class="co">## Immune_marker1                                                                  100</span>
<span class="co">## Immune_marker2                                                                  100</span>
<span class="co">##                                              Average_bootstrap_cell_number</span>
<span class="co">## Tumour_marker                                                       426.33</span>
<span class="co">## Immune_marker1,Immune_marker2,Immune_marker4                         23.36</span>
<span class="co">## Immune_marker1,Immune_marker2                                       158.45</span>
<span class="co">## Immune_marker1,Immune_marker3                                        24.48</span>
<span class="co">## Immune_marker1                                                      644.67</span>
<span class="co">## Immune_marker2                                                      521.67</span>
<span class="co">##                                              Enrichment.p Depletion.p</span>
<span class="co">## Tumour_marker                                        0.01        1.00</span>
<span class="co">## Immune_marker1,Immune_marker2,Immune_marker4         0.01        1.00</span>
<span class="co">## Immune_marker1,Immune_marker2                        0.01        1.00</span>
<span class="co">## Immune_marker1,Immune_marker3                        0.01        1.00</span>
<span class="co">## Immune_marker1                                       1.00        0.01</span>
<span class="co">## Immune_marker2                                       1.00        0.01</span></code></pre>
</div>
<div class="section level3">
<h3 id="removing-incorrect-phenotypes">Removing incorrect phenotypes<a class="anchor" aria-label="anchor" href="#removing-incorrect-phenotypes"></a>
</h3>
<p>If you identify incorrect phenotypes or have any you want to exclude you can do that with <code>select_phenotypes</code>.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_celltypes.html">select_celltypes</a></span><span class="op">(</span><span class="va">formatted_image</span>, keep<span class="op">=</span><span class="cn">TRUE</span>,
                                celltypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>,<span class="st">"Immune_marker1,Immune_marker3"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>,
                                             <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span><span class="op">)</span>,
                                feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span>
<span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">data_subset</span>, feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Immune_marker1,Immune_marker2"               </span>
<span class="co">## [2] "Tumour_marker"                               </span>
<span class="co">## [3] "Immune_marker1,Immune_marker2,Immune_marker4"</span>
<span class="co">## [4] "Immune_marker1,Immune_marker3"</span></code></pre>
<p>In this vignette we will work with all the original phenotypes present in <code>formatted_image</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="cell-percentages">Cell percentages<a class="anchor" aria-label="anchor" href="#cell-percentages"></a>
</h2>
<p>We can obtain the number and proportion of each cell type with <code>calculate_cell_proportions</code>. We can use <code>reference_celltypes</code> to specify cell types to use as the reference. For example, “Total” will calculate the proportion of each cell type against all cells. We can exclude any cell types that are not of interest e.g. “Undefined” with <code>celltypes_to_exclude</code>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cell_proportions.html">calculate_cell_proportions</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                      reference_celltypes<span class="op">=</span><span class="cn">NULL</span>, 
                                      feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span>,
                                      celltypes_to_exclude <span class="op">=</span> <span class="st">"Others"</span>,
                                      plot.image <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells</span></code></pre></div>
<pre><code><span class="co">##   Cell_type Number_of_celltype Proportion Percentage Proportion_name</span>
<span class="co">## 5    Tumour                819 0.41679389  41.679389          /Total</span>
<span class="co">## 3   Immune3                630 0.32061069  32.061069          /Total</span>
<span class="co">## 1   Immune1                338 0.17201018  17.201018          /Total</span>
<span class="co">## 2   Immune2                178 0.09058524   9.058524          /Total</span></code></pre>
<p>To visualize the cell type proportions as barplots we can use <code>plot_cell_percentages</code>. (This one doesn’t work)</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_percentages.html">plot_cell_percentages</a></span><span class="op">(</span>cell_proportions <span class="op">=</span> <span class="va">p_cells</span>, 
                      cells_to_exclude <span class="op">=</span> <span class="st">"Tumour"</span>, cellprop_colname<span class="op">=</span><span class="st">"Proportion_name"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-25-1.png" width="576"><img src="introduction_files/figure-html/unnamed-chunk-25-2.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="visualizing-tissues">Visualizing tissues<a class="anchor" aria-label="anchor" href="#visualizing-tissues"></a>
</h2>
<p>In addition to the marker level tissue plots for QC, SPIAT has other methods for visualizing markers and phenotypes in tissues.</p>
<div class="section level3">
<h3 id="d-surface-plot">3D surface plot<a class="anchor" aria-label="anchor" href="#d-surface-plot"></a>
</h3>
<p>We can visualize a selected marker in 3D with <code>marker_surface_plot</code>. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot.html">marker_surface_plot</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, marker<span class="op">=</span><span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-9b04046d4f1e190434aa" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-9b04046d4f1e190434aa">{"x":{"visdat":{"c7d833e8dd9d":["function () ","plotlyVisDat"]},"cur_data":"c7d833e8dd9d","attrs":{"c7d833e8dd9d":{"z":{},"reversescale":true,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"surface","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":"mean_marker_level"}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.5}},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"colorbar":{"title":"mean_marker_level","ticklen":2,"len":0.5,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666667","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"z":[[0.125191269449563,0.103297779571842,0.232369497412571,0.0968945116132624,0.245821000833457,0.108477854473062,0.188146284275383,0.0855663819124098,0.106455956082798,0.0836729185088256,0.000972979947507266,0.10908774321612,0.260752105013254,0.111616877549738,0.117809323826204],[0.0669737780795037,0.168060523887042,0.123851788914708,0.0652160787707617,0.137064226696656,0.167068895218269,0.208839929597127,0.217182045989476,0.153028953542062,0.101908558478961,0.250905472871684,0.115608800289016,0.0630869672554789,0.15422507013329,0.137118143525146],[0.0770731825392935,0.18223555342772,0.169863248004556,0.110457345154145,0.123683528322369,0.256666242236807,0.197535585914841,0.205175367670763,0.398368067483609,0.236723314631125,0.0921097911024096,0.0978113581362956,0.120486987320687,0.0714347491849658,0.128579403279495],[0.183355378346475,0.0840211821824499,0.156470975345885,0.109512691255049,0.311836113672822,0.10638965303937,0.0846213201462295,0.0951629225032657,0.320900460901452,0.0607645190380459,0.075970068833066,0.0422723798563832,0.110473067429388,0.174383616384122,0.16930590675519],[0.117877788087379,0.0911246744037992,0.0888451311745254,0.450799536318174,0.0498348344735443,0.0384403640090901,0.0949617840358235,0.101323236585494,0.442350201187526,0.263699293499997,0.0116412082569235,0.0937181497899453,0.0688630559250375,0.140349561935985,0.159157279819624],[0.115713955376862,0.0388572424520531,0.0543304237813087,0.489338523250679,0.118302998866826,0.10970227111712,0.115691392000113,0.106851413216416,0.183470199276786,0.252552831996042,0.1605141681016,0.0142415064822186,0.167589273920608,0.0904070966333553,0.1740785502486],[0.0952941817438256,0.223295437327991,0.167151897909475,0.327782294394654,0.26780563805236,0.17487806539248,0.106737297496695,0.0287479069077426,0.0937404116761288,0.187116121898025,0.203468481184648,0.153318012035664,0.172397496910186,0.217984044432595,0.0952723853825924],[0.241178607217228,0.177820935350879,0.244369010372094,0.191777521256513,0.385462385119794,0.346025486834137,0.164994207379299,0.176637683478463,0.0705853825999823,0.220301507076569,0.280284328364283,0.23191874221366,0.3092057024028,0.161892367470978,0.138105270173174],[0.108001416131626,0.200479652746015,0.401684525730659,0.256915239520428,0.15767280944718,0.128175848453201,0.401128881144876,0.115848787692859,0.236011038387042,0.396842825796158,0.14924992613937,0.0129725199785328,0.283823173693404,0.060697934929718,0.177885166700364],[0.13298499440072,0.421830953947071,0.12565773010779,0.0791210181457949,0.125600077609211,0.23434170517727,0.21357120759885,0.165429839705615,0.138426775190248,0.238750767050283,0.159108911257583,0.271948774317281,0.300170139716372,0.209090433706112,0.138218104509174],[0.223843203182142,0.180047622196063,0.271168802419273,0.0367470980959641,0.168180114790674,0.148463696123383,0.467917012822402,0.0751965478251806,0.154491144484662,0.280272938093047,0.401455401154963,0.114634047354788,0.0776464819452332,0.0720094143334626,0.0956282410346853],[0.252875808354409,0.194031214295524,0.180685074577672,0.114705239082631,0.036255174856877,0.21755259457899,0.240142831767568,0.11362898344352,0.0718210075456046,0.138115933744268,0.0566231260482997,0.0947171380509093,0.128337771728004,0.150706805389431,0.132334860649472],[0.0866704892744729,0.137229959819496,0.42339521794549,0.0858841310919905,0.0625237264301085,0.390716905486056,0.0733413303474559,0.00697395576001184,0.105811612488265,0.191381278133629,0.176903611361948,0.0548309092529789,0.167217284399899,0.0907089227369907,0.153290760308997],[0.0797358129408459,0.0857224292781979,0.145216351144814,0.316097404433341,0.242343727228578,0.272932980294295,0.0651623089244037,0.201266366496379,0.0708396839835418,0.0947943677313092,0.153418837358351,0.101721639754777,0.0985657533228083,0.230277673675945,0.123820337362842],[0.106480704408356,0.12738995546878,0.0819096247731764,0.206481977486273,0.220235953826918,0.107590904033367,0.084461669623901,0.057107137384521,0.134485421778619,0.0627530258517664,0.0468683369589003,0.185071134820385,0.100040051594318,0.0519429462990737,0.211956827804863]],"reversescale":true,"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3 id="d-stacked-surface-plot">3D stacked surface plot<a class="anchor" aria-label="anchor" href="#d-stacked-surface-plot"></a>
</h3>
<p>To visualize multiple markers in 3D in a single plot we can use <code>marker_surface_plot_stack</code>. This shows normalized intensity level of specified markers and enables the identification of co-occurring and mutually exclusive markers.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot_stack.html">marker_surface_plot_stack</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, markers<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-2fe19c3296e47ecbb967" style="width:700px;height:432.632880098888px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-2fe19c3296e47ecbb967">{"x":{"visdat":{"c7d838802fba":["function () ","plotlyVisDat"]},"cur_data":"c7d838802fba","attrs":{"c7d838802fba":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[0.0667121967610992,0.283630675803424,0.112754006000685,0.234775612894574,0.0796015465093539,0.248077253661392,0.0253149237342597,0.0451236395981605,0.0946014872596146,0.119735752951837,0.0760694504897262,0.152538078795834,0.0688038111818676,0.0529597999325873,0.0887946903773845],[0.172680136622811,0.074078741228831,0.169366481855747,0.0468160088480532,0.131275421809517,0.153548601495502,0.0542377569621041,0.086317231902356,0.0943201152042358,0.140833466014991,0.0869613366433822,0.143270086588369,0.0889805506433455,0.192434679225336,0.054907757543153],[0.029070964636436,0.0961604341554385,0.039174292984745,0.135584933964907,0.0766066258975714,0.418654960757314,0.682891732790788,0.520107058434695,0.18476542681917,0.0619614704562987,0.102434694842037,0.168318635292263,0.0744561523455201,0.083947657624439,0.109629751918594],[0.179564605020606,0.179370269671532,0.0679081905630976,0.0657471170786242,0.39448676999966,0.992323413922979,0.963175193652883,0.824048973975986,0.223097407853188,0.164726929152674,0.117211032733841,0.128279832656747,0.0888895065429606,0.113060142127466,0.0570759272100496],[0.155126565030244,0.108091165065675,0.0378263767781359,0.0429306062590208,0.797310058479897,0.884873996192985,0.791663250785058,0.951233775337799,0.0925008019132936,0.0327204766642381,0.179953823694684,0.0405845752017644,0.0694861256853885,0.168578171681113,0.201901339721787],[0.192859358608764,0.0579813451001589,0.245495510294604,0.0705588108828678,0.917938170125817,0.946065468500667,0.931529587213757,0.863388436097001,0.775580780127284,0.290472130351181,0.118798298008694,0.149711914009191,0.0103663719175952,0.116637170557147,0.231651503031122],[0.0415206327308158,0.207304051505547,0.0788876550316076,0.0982868233705891,0.418190156034581,0.622034734608503,0.942730878475008,1,0.808259656557183,0.701840899664097,0.0860593691752759,0.120805733514622,0.102137249729526,0.0272888463999916,0.0963950256083411],[0.0971865033691279,0.0844365005163432,0.0982605593786862,0.274935533188152,0.146699831941568,0.0281143300485473,0.676904519469364,0.824397399064985,0.796650055460852,0.52886640415436,0.207616763959548,0.455802048482518,0.278128864232699,0.0704179678088165,0.136295889209102],[0.0554833274548579,0.095632774707128,0.394956641664033,0.787108608622592,0.64511473847833,0.139875264308995,0.143726096995548,0.693894223348995,0.393643286942211,0.176539664129911,0.876485452894585,0.997310308820912,0.361758402307964,0.122087594430063,0.0490072657583349],[0.209264459518433,0.173294323186741,0.748273244898906,0.964660000128666,0.869595461933072,0.468454282027372,0.150408573120283,0.0807499619057284,0.103462595404715,0.127719543212204,0.758509271817272,0.614912180376541,0.144665580755262,0.270371784102769,0.168947824055886],[0.272743408060306,0.218812797086556,0.695621443830594,0.894743302900533,0.823563467418436,0.686708159778526,0.0906801719969054,0.121530880842101,0.210676365125582,0.0924368194812089,0.0705948220160682,0.0493662062902429,0.0512214701534304,0.106771406821427,0.102269078225316],[0.162666164914993,0.0923754748466673,0.199876299947495,0.898143044921837,0.939599423031274,0.417448180245486,0.0633877085729595,0,0.0444049937492901,0.0348969767711506,0.229588631306728,0.0329077392961837,0.0897690471581768,0.189437466758341,0.174301598277323],[0.0828580812062836,0.243181360161585,0.17237788161065,0.715125612578973,0.857508380078494,0.123497180557699,0.0268687840411867,0.0822197854911925,0.167465736031817,0.139054596443811,0.0923835941379704,0.0846237774249925,0.172210065491038,0.113079761478431,0.0220435133164901],[0.06364352834345,0.119195015172604,0.0382388935331727,0.234286877292706,0.145669177404662,0.078432271353091,0.206914810209141,0.165791399580525,0.089427691596664,0.0952156587533696,0.0945706205606575,0.0305698771405312,0.208470891691743,0.103544942353813,0.0510917632504402],[0.150600453786915,0.0909322289034476,0.180722984233276,0.0626489273908985,0.0624979015257676,0.13682940395187,0.233653164205698,0.200142387788189,0.166728954272254,0.11126878998798,0.128854157922411,0.136603676068912,0.173345976207736,0.145446950016326,0.175753590146365]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(230,159,0)"]],"colorbar":{"title":"Tumour_marker"},"inherit":true},"c7d838802fba.1":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"z":[[1.25435514688828,1.2095250187641,1.47381827124813,1.19641338948069,1.50136219527255,1.22013198105342,1.38326476323838,1.17321738424201,1.21599184787246,1.1693402405132,1,1.22138081760919,1.53193581862609,1.22655959069894,1.23923953170088],[1.13514630390503,1.34213622609286,1.25161236424683,1.13154715705111,1.27866676635019,1.34010572111074,1.42563803384584,1.44271973935669,1.31135688354688,1.20668038504263,1.51177339669318,1.23473363736136,1.12718748928896,1.31380610750961,1.27877716895584],[1.15582631419298,1.37116167585084,1.34582756783929,1.2241852782367,1.25126782603228,1.52356941597448,1.40249073396505,1.41813430640927,1.81372466380046,1.48273334987777,1.18661597322874,1.19829076706313,1.2447224400084,1.14428079581715,1.26129284729814],[1.37345468143674,1.17005336140881,1.31840492747836,1.22225096097773,1.63653781063816,1.21585608267703,1.17128223181543,1.19286770708409,1.65509838959981,1.12243193630354,1.15356752726308,1.08456657205899,1.22421747189872,1.35508368437239,1.34468632997554],[1.23937972230629,1.18459880245959,1.1799311037234,1.92108577793626,1.10005180585745,1.07671995818575,1.19245584660335,1.20548185271067,1.90378452635021,1.53797061884317,1.02184476045804,1.18990932328095,1.13901487709051,1.28539397158483,1.32390552945689],[1.23494895780992,1.07757357787428,1.10925718361067,2,1.24025040367453,1.22263915352053,1.23490275599028,1.21680160429169,1.37368979411389,1.51514660585372,1.32668395701097,1.02716925204216,1.34117127274409,1.1831294568428,1.35445901676489],[1.19313647960983,1.4552378037909,1.34027568128164,1.66918995192965,1.54637896093174,1.35609614115838,1.21656793563654,1.05687323223578,1.18995490775448,1.38115535484239,1.41463920625422,1.31194877316228,1.35101681376456,1.44436194866919,1.19309184836684],[1.49185621418955,1.36212209855597,1.49838903207282,1.39070025296718,1.78729838835825,1.70654556124658,1.33585749379941,1.35969921698981,1.14254159329431,1.44910729296253,1.5719309075894,1.47289528393854,1.63115165818311,1.32950602213878,1.2807984553909],[1.21915640374668,1.40851914213501,1.82051559795322,1.5240792743931,1.32086585888062,1.26046650966677,1.81937783425674,1.23522504673111,1.48127485991293,1.81060150798333,1.30361877127726,1.02457081625756,1.57917721187448,1.12229559558655,1.36225362165453],[1.27031394057885,1.86176836136513,1.25531029342682,1.16001955762422,1.25519224148936,1.4778566555931,1.43532601873053,1.33674951481172,1.28145678401682,1.4868848557466,1.32380648773967,1.5548626394421,1.61265001978882,1.42615097771017,1.28102950022513],[1.45635943463005,1.36668156610178,1.5532655327078,1.07325274814945,1.34238110598922,1.30200885012953,1.95613631894792,1.15198362967142,1.3143509337264,1.57190758434027,1.8200464318156,1.23273768791817,1.15700022872033,1.14545750690248,1.19382051495066],[1.51580794726651,1.39531501965152,1.36798684324582,1.23288346341118,1.0722454632461,1.44347849188253,1.48973531220565,1.23067967230865,1.145071716401,1.28082029061502,1.11395182740451,1.19195489810633,1.26079807129519,1.3066019449881,1.26898269647254],[1.17547820582781,1.27900612920065,1.86497142108109,1.1738680222404,1.12603417117901,1.79805778864419,1.1481848000792,1.01228787717478,1.21467245996034,1.38988888711978,1.36024374329215,1.11028200093969,1.34040956970052,1.18374749001032,1.3118929712593],[1.16127844004024,1.17353691408585,1.29535943551972,1.64526342778898,1.49424196811369,1.55687794537535,1.13143705541291,1.41013005379974,1.14306231263466,1.19211303719181,1.31215522778233,1.20629764156954,1.19983550173341,1.46953495567579,1.25154796258644],[1.2160425236949,1.25885727864055,1.16572963825055,1.42080978143699,1.44897306307971,1.21831582008167,1.17095532398068,1.11494291152758,1.27338628546164,1.12650369533935,1.09397746757679,1.37696794419133,1.20285434344272,1.10436847367818,1.43202033958071]],"type":"surface","colorscale":[[0,1],["rgb(255,255,255)","rgb(86,180,233)"]],"colorbar":{"title":"Immune_marker1"},"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"zaxis":{"title":[]}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.333333333333333}},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"colorbar":{"title":"Tumour_marker","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(230,159,0)"]],"showscale":true,"z":[[0.0667121967610992,0.283630675803424,0.112754006000685,0.234775612894574,0.0796015465093539,0.248077253661392,0.0253149237342597,0.0451236395981605,0.0946014872596146,0.119735752951837,0.0760694504897262,0.152538078795834,0.0688038111818676,0.0529597999325873,0.0887946903773845],[0.172680136622811,0.074078741228831,0.169366481855747,0.0468160088480532,0.131275421809517,0.153548601495502,0.0542377569621041,0.086317231902356,0.0943201152042358,0.140833466014991,0.0869613366433822,0.143270086588369,0.0889805506433455,0.192434679225336,0.054907757543153],[0.029070964636436,0.0961604341554385,0.039174292984745,0.135584933964907,0.0766066258975714,0.418654960757314,0.682891732790788,0.520107058434695,0.18476542681917,0.0619614704562987,0.102434694842037,0.168318635292263,0.0744561523455201,0.083947657624439,0.109629751918594],[0.179564605020606,0.179370269671532,0.0679081905630976,0.0657471170786242,0.39448676999966,0.992323413922979,0.963175193652883,0.824048973975986,0.223097407853188,0.164726929152674,0.117211032733841,0.128279832656747,0.0888895065429606,0.113060142127466,0.0570759272100496],[0.155126565030244,0.108091165065675,0.0378263767781359,0.0429306062590208,0.797310058479897,0.884873996192985,0.791663250785058,0.951233775337799,0.0925008019132936,0.0327204766642381,0.179953823694684,0.0405845752017644,0.0694861256853885,0.168578171681113,0.201901339721787],[0.192859358608764,0.0579813451001589,0.245495510294604,0.0705588108828678,0.917938170125817,0.946065468500667,0.931529587213757,0.863388436097001,0.775580780127284,0.290472130351181,0.118798298008694,0.149711914009191,0.0103663719175952,0.116637170557147,0.231651503031122],[0.0415206327308158,0.207304051505547,0.0788876550316076,0.0982868233705891,0.418190156034581,0.622034734608503,0.942730878475008,1,0.808259656557183,0.701840899664097,0.0860593691752759,0.120805733514622,0.102137249729526,0.0272888463999916,0.0963950256083411],[0.0971865033691279,0.0844365005163432,0.0982605593786862,0.274935533188152,0.146699831941568,0.0281143300485473,0.676904519469364,0.824397399064985,0.796650055460852,0.52886640415436,0.207616763959548,0.455802048482518,0.278128864232699,0.0704179678088165,0.136295889209102],[0.0554833274548579,0.095632774707128,0.394956641664033,0.787108608622592,0.64511473847833,0.139875264308995,0.143726096995548,0.693894223348995,0.393643286942211,0.176539664129911,0.876485452894585,0.997310308820912,0.361758402307964,0.122087594430063,0.0490072657583349],[0.209264459518433,0.173294323186741,0.748273244898906,0.964660000128666,0.869595461933072,0.468454282027372,0.150408573120283,0.0807499619057284,0.103462595404715,0.127719543212204,0.758509271817272,0.614912180376541,0.144665580755262,0.270371784102769,0.168947824055886],[0.272743408060306,0.218812797086556,0.695621443830594,0.894743302900533,0.823563467418436,0.686708159778526,0.0906801719969054,0.121530880842101,0.210676365125582,0.0924368194812089,0.0705948220160682,0.0493662062902429,0.0512214701534304,0.106771406821427,0.102269078225316],[0.162666164914993,0.0923754748466673,0.199876299947495,0.898143044921837,0.939599423031274,0.417448180245486,0.0633877085729595,0,0.0444049937492901,0.0348969767711506,0.229588631306728,0.0329077392961837,0.0897690471581768,0.189437466758341,0.174301598277323],[0.0828580812062836,0.243181360161585,0.17237788161065,0.715125612578973,0.857508380078494,0.123497180557699,0.0268687840411867,0.0822197854911925,0.167465736031817,0.139054596443811,0.0923835941379704,0.0846237774249925,0.172210065491038,0.113079761478431,0.0220435133164901],[0.06364352834345,0.119195015172604,0.0382388935331727,0.234286877292706,0.145669177404662,0.078432271353091,0.206914810209141,0.165791399580525,0.089427691596664,0.0952156587533696,0.0945706205606575,0.0305698771405312,0.208470891691743,0.103544942353813,0.0510917632504402],[0.150600453786915,0.0909322289034476,0.180722984233276,0.0626489273908985,0.0624979015257676,0.13682940395187,0.233653164205698,0.200142387788189,0.166728954272254,0.11126878998798,0.128854157922411,0.136603676068912,0.173345976207736,0.145446950016326,0.175753590146365]],"type":"surface","frame":null},{"colorbar":{"title":"Immune_marker1","ticklen":2,"len":0.333333333333333,"lenmode":"fraction","y":0.666666666666667,"yanchor":"top"},"colorscale":[[0,"rgb(255,255,255)"],[1,"rgb(86,180,233)"]],"showscale":true,"z":[[1.25435514688828,1.2095250187641,1.47381827124813,1.19641338948069,1.50136219527255,1.22013198105342,1.38326476323838,1.17321738424201,1.21599184787246,1.1693402405132,1,1.22138081760919,1.53193581862609,1.22655959069894,1.23923953170088],[1.13514630390503,1.34213622609286,1.25161236424683,1.13154715705111,1.27866676635019,1.34010572111074,1.42563803384584,1.44271973935669,1.31135688354688,1.20668038504263,1.51177339669318,1.23473363736136,1.12718748928896,1.31380610750961,1.27877716895584],[1.15582631419298,1.37116167585084,1.34582756783929,1.2241852782367,1.25126782603228,1.52356941597448,1.40249073396505,1.41813430640927,1.81372466380046,1.48273334987777,1.18661597322874,1.19829076706313,1.2447224400084,1.14428079581715,1.26129284729814],[1.37345468143674,1.17005336140881,1.31840492747836,1.22225096097773,1.63653781063816,1.21585608267703,1.17128223181543,1.19286770708409,1.65509838959981,1.12243193630354,1.15356752726308,1.08456657205899,1.22421747189872,1.35508368437239,1.34468632997554],[1.23937972230629,1.18459880245959,1.1799311037234,1.92108577793626,1.10005180585745,1.07671995818575,1.19245584660335,1.20548185271067,1.90378452635021,1.53797061884317,1.02184476045804,1.18990932328095,1.13901487709051,1.28539397158483,1.32390552945689],[1.23494895780992,1.07757357787428,1.10925718361067,2,1.24025040367453,1.22263915352053,1.23490275599028,1.21680160429169,1.37368979411389,1.51514660585372,1.32668395701097,1.02716925204216,1.34117127274409,1.1831294568428,1.35445901676489],[1.19313647960983,1.4552378037909,1.34027568128164,1.66918995192965,1.54637896093174,1.35609614115838,1.21656793563654,1.05687323223578,1.18995490775448,1.38115535484239,1.41463920625422,1.31194877316228,1.35101681376456,1.44436194866919,1.19309184836684],[1.49185621418955,1.36212209855597,1.49838903207282,1.39070025296718,1.78729838835825,1.70654556124658,1.33585749379941,1.35969921698981,1.14254159329431,1.44910729296253,1.5719309075894,1.47289528393854,1.63115165818311,1.32950602213878,1.2807984553909],[1.21915640374668,1.40851914213501,1.82051559795322,1.5240792743931,1.32086585888062,1.26046650966677,1.81937783425674,1.23522504673111,1.48127485991293,1.81060150798333,1.30361877127726,1.02457081625756,1.57917721187448,1.12229559558655,1.36225362165453],[1.27031394057885,1.86176836136513,1.25531029342682,1.16001955762422,1.25519224148936,1.4778566555931,1.43532601873053,1.33674951481172,1.28145678401682,1.4868848557466,1.32380648773967,1.5548626394421,1.61265001978882,1.42615097771017,1.28102950022513],[1.45635943463005,1.36668156610178,1.5532655327078,1.07325274814945,1.34238110598922,1.30200885012953,1.95613631894792,1.15198362967142,1.3143509337264,1.57190758434027,1.8200464318156,1.23273768791817,1.15700022872033,1.14545750690248,1.19382051495066],[1.51580794726651,1.39531501965152,1.36798684324582,1.23288346341118,1.0722454632461,1.44347849188253,1.48973531220565,1.23067967230865,1.145071716401,1.28082029061502,1.11395182740451,1.19195489810633,1.26079807129519,1.3066019449881,1.26898269647254],[1.17547820582781,1.27900612920065,1.86497142108109,1.1738680222404,1.12603417117901,1.79805778864419,1.1481848000792,1.01228787717478,1.21467245996034,1.38988888711978,1.36024374329215,1.11028200093969,1.34040956970052,1.18374749001032,1.3118929712593],[1.16127844004024,1.17353691408585,1.29535943551972,1.64526342778898,1.49424196811369,1.55687794537535,1.13143705541291,1.41013005379974,1.14306231263466,1.19211303719181,1.31215522778233,1.20629764156954,1.19983550173341,1.46953495567579,1.25154796258644],[1.2160425236949,1.25885727864055,1.16572963825055,1.42080978143699,1.44897306307971,1.21831582008167,1.17095532398068,1.11494291152758,1.27338628546164,1.12650369533935,1.09397746757679,1.37696794419133,1.20285434344272,1.10436847367818,1.43202033958071]],"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script><p>The stacked surface plots of the Tumour_marker (tumour cell) and Immune_marker1 (T cell) markers in this prostate tissue shows how Tumour_marker and Immune_marker1 are mutually exclusive as the peaks and valleys are opposite.</p>
</div>
<div class="section level3">
<h3 id="categorical-dot-plot">Categorical dot plot<a class="anchor" aria-label="anchor" href="#categorical-dot-plot"></a>
</h3>
<p>We can see the location of all cell types (or any column in the data) in the tissue with <code>plot_cell_basic</code>. Each dot in the plot corresponds to a cell and cells are coloured by cell type. Any cell types present in the data but not in the cell types of interest will be put in the category “OTHER” and coloured lightgrey.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"darkcyan"</span>, <span class="st">"darkgreen"</span><span class="op">)</span>
  
<span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>, <span class="st">"Immune3"</span><span class="op">)</span>, 
                     <span class="va">my_colors</span>, <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="cell-distances">Cell distances<a class="anchor" aria-label="anchor" href="#cell-distances"></a>
</h2>
<p>We can calculate the distances between two cell types (cell type A and cell type B) by identifying the closest cell of cell type B to each of the cells of cell type A with <code>calculate_distances_between_cell_types</code>.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_distances_between_cell_types.html">calculate_distances_between_cell_types</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                                    cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune3"</span><span class="op">)</span>,
                                                    feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p>This creates a distribution of minimum distances between phenotypes A and B, which can be visualized as a violin plot with <code>plot_cell_distances_violin</code>. Visualization of this distribution often reveals whether pairs of cells are evenly spaced across the image, or whether there are clusters of pairs of phenotypes.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_distances_violin.html">plot_cell_distances_violin</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>From this plot we can see that T_helper cells seem to be more closely interacting with each other, as there are shorter distances between those cells, than between T_cyto cells or between T_helper and T_cyto cells.</p>
<p>We can also calculate summary statistics for the distances between each combination of cell types, the mean, median and standard deviation, with <code>calculate_summary_distances_between_cell_types</code>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summary_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_between_cell_types.html">calculate_summary_distances_between_cell_types</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                                                    all_combinations <span class="op">=</span> <span class="cn">TRUE</span>,
                                                                    feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "All markers are used in pair-wise distance calculation: "</span>
<span class="co">## [1] "Others"  "Immune1" "Tumour"  "Immune3" "Immune2"</span></code></pre>
<p>These cell distances can then be visualized as a heatmap with <code>plot_distance_heatmap</code>.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_distance_heatmap.html">plot_distance_heatmap</a></span><span class="op">(</span><span class="va">summary_distances</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
<p>This plot shows that Tumour cells are interacting most closely with Immune3 cells.</p>
</div>
<div class="section level2">
<h2 id="cell-colocalisation">Cell colocalisation<a class="anchor" aria-label="anchor" href="#cell-colocalisation"></a>
</h2>
<p>With SPIAT we can quantify how much two cell types are mixing, and thus potentially interacting, through a variety of ways.</p>
<div class="section level3">
<h3 id="cells-within-radius">Cells within radius<a class="anchor" aria-label="anchor" href="#cells-within-radius"></a>
</h3>
<p>To determine whether two cell types are interacting with another, or if there is repulsion between them, SPIAT uses the concept of gradients. The assumption is that, if marker A intensity is high close to cells of marker B, and this value decreases as the distance from B increases, it suggests the cells are close and interacting. Conversely, if we see that marker A intensity is low when close to cells of marker B but increases with distance, it suggests there is repulsion between the two cell types.</p>
<p><code>plot_average_intensity</code> calculates the average intensity of a target marker for a number of user-supplied radii values. It plots the intensity level at each specified radius as a line graph. The radius unit is pixels.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_average_intensity.html">plot_average_intensity</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_marker<span class="op">=</span><span class="st">"Immune_marker3"</span>, target_marker<span class="op">=</span><span class="st">"Immune_marker2"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p>This plot shows that high levels of Immune_marker3 were observed in cells near Immune_marker2 cells and these levels decreased at larger radii. This suggests Immune_marker2 and Immune_marker3 cells may be closely interacting in this tissue.</p>
<p>We can use <code>average_marker_intensity_within_radius</code> to calculate the average intensity of the target_marker within a radius from the cells positive for the reference marker. Note that it pools all cells with the target marker that are within the specific radius of any reference cell. Results represent the average intensities within a radius, but do not correspond to metrics for each cell. This function can also be used to help identify radii values for <code>plot_average_intensity</code>.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_marker_intensity_within_radius.html">average_marker_intensity_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>,
                                        reference_marker <span class="op">=</span><span class="st">"Immune_marker3"</span>,
                                        target_marker <span class="op">=</span> <span class="st">"Immune_marker2"</span>,
                                        radius<span class="op">=</span><span class="fl">30</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.5995357</span></code></pre>
<p>We can calculate the average percentage of cells of one cell type (target) within a radius of another cell type (reference).</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_percentage_of_cells_within_radius.html">average_percentage_of_cells_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                          reference_celltype <span class="op">=</span> <span class="st">"Immune1"</span>, 
                                          target_celltype <span class="op">=</span> <span class="st">"Immune2"</span>, 
                                          radius<span class="op">=</span><span class="fl">100</span>, feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 4.768123</span></code></pre>
</div>
<div class="section level3">
<h3 id="average-minimum-distance-amd">Average minimum distance (AMD)<a class="anchor" aria-label="anchor" href="#average-minimum-distance-amd"></a>
</h3>
<p>Distance-based metrics can also indicate the relationship between two cell types. AMD calculates the average minimum distance between two cell types.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_d_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_minimum_distances_between_cell_types.html">calculate_minimum_distances_between_cell_types</a></span><span class="op">(</span>
              <span class="va">formatted_image</span>,
              feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>,
              all_combinations <span class="op">=</span> <span class="cn">FALSE</span>,
              cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune1"</span><span class="op">)</span>
            <span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Markers had been selected in pair-wise distance calculation: "</span>
<span class="co">## [1] "Immune1" "Tumour"</span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_d_df</span><span class="op">$</span><span class="va">Mean</span></code></pre></div>
<pre><code><span class="co">## [1]  85.84773 187.52474</span></code></pre>
</div>
<div class="section level3">
<h3 id="average-pairwise-distance-apd">Average pairwise distance (APD)<a class="anchor" aria-label="anchor" href="#average-pairwise-distance-apd"></a>
</h3>
<p>APD calculates the average pairwise distance between two cell types.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_between_cell_types.html">calculate_summary_distances_between_cell_types</a></span><span class="op">(</span>
          <span class="va">formatted_image</span>,
          feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>,
          all_combinations <span class="op">=</span> <span class="cn">FALSE</span>,
          cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune1"</span><span class="op">)</span>
        <span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Markers had been selected in pair-wise distance calculation: "</span>
<span class="co">## [1] "Immune1" "Tumour"</span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d_df</span><span class="op">$</span><span class="va">Mean</span></code></pre></div>
<pre><code><span class="co">## [1]  85.84773 187.52474</span></code></pre>
</div>
<div class="section level3">
<h3 id="normalised-mixing-score">(Normalised) mixing score<a class="anchor" aria-label="anchor" href="#normalised-mixing-score"></a>
</h3>
<p>This score was originally defined as the number of immune-tumor interactions divided by the number of immune-immune interactions <span class="citation">(Keren et al. 2018)</span>. SPIAT generalizes this method to allow calculation of any two cell types. <code>mixing_score_summary</code> returns the mixing score between a reference cell type and a target cell type. This mixing score is defined as the number of target-reference interactions/number of reference-reference interactions within a specified radius. The higher the score the greater the mixing of the two cell types. The normalised score is normalised for the number of target and reference cells in the image.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mixing_score_summary.html">mixing_score_summary</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_celltype <span class="op">=</span> <span class="st">"Immune1"</span>, 
                     target_celltype <span class="op">=</span> <span class="st">"Immune2"</span>, radius<span class="op">=</span><span class="fl">100</span>, feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##   Reference  Target Number_of_reference_cells Number_of_target_cells</span>
<span class="co">## 2   Immune1 Immune2                       338                    178</span>
<span class="co">##   Reference_target_interaction Reference_reference_interaction Mixing_score</span>
<span class="co">## 2                          583                            1184    0.4923986</span>
<span class="co">##   Normalised_mixing_score</span>
<span class="co">## 2                1.864476</span></code></pre>
</div>
<div class="section level3">
<h3 id="cross-k-function">Cross K function<a class="anchor" aria-label="anchor" href="#cross-k-function"></a>
</h3>
<p>Cross K function is similar to mixing score, but calculates the score across all possible distances. It also compares the behaviour of the image with an image that has randomly distributed points of the same number. There are 4 patterns that can be distinguished from K-cross function, as illustrated in the plots below (generated <a href="https://blog.jlevente.com/understanding-the-cross-k-function/" class="external-link">here</a>).</p>
<p><img src="../inst/articles/cross-k-function.png" width="669"></p>
<p>Here, the black line represents our image, the red line represents a randomly distibuted point pattern.</p>
<ul>
<li>1st plot: The red line and black line are close to each other, it means the two types of points are randomly independently distributed.<br>
</li>
<li>2nd plot: The red line is under the black line, and in the middle the difference is dramatic, it means the points are mixed and split into clusters.<br>
</li>
<li>3rd plot: With the increase of radius, the black line diverges further from the red line, it means that there is one mixed cluster of two types of points.<br>
</li>
<li>4th plot: The red line is above the black line, it means that the two types of points form separated clusters.</li>
</ul>
<p>We can calculate the cross K-function using SPIAT.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_cross</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cross_functions.html">calculate_cross_functions</a></span><span class="op">(</span><span class="va">formatted_image</span>, method <span class="op">=</span> <span class="st">"Kcross"</span>, 
                                      cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune3"</span><span class="op">)</span>, 
                                      feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span>,
                                      dist <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-40-1.png" width="700"> There is another pattern in cross K curve which is not identified previously, that is when there is a “ring” of one cell type surrounding the area of another cell type. For this pattern, the observed and expected curves in cross K function has a crossing. We observed crossing in many example images where rings exist. However, crossing is not exclusively present in ring images. When separate clusters of two cell types are very close, the crossing can also happen at a low distance. In images with infiltration, crossing may also happen at an extremely low distance due to randomness. To use crossing as a metric indicating the ring pattern, we need to choose a reasonable distance for cross K function (generally a quarter to half of image size, but should also consider the cluster size), and filter out the extremely low crossing distance.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/crossing_of_crossK.html">crossing_of_crossK</a></span><span class="op">(</span><span class="va">df_cross</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Crossing of cross K function is detected for this image, indicating a potential immune ring."</span>
<span class="co">## [1] "The crossing happens at the 50 % of the specified distance."</span></code></pre>
<pre><code><span class="co">## [1] 0.5</span></code></pre>
<p>The result shows that the crossing happens at 50% of the specified distance (100) of the cross K function, which is very close to the edge of the tumour cluster. This means that the crossing is not due to the randomness in cell distribution, nor due to two close located immune and tumour clusters. This result aligns with the observation that there is an immune ring surrounding the tumour cluster.</p>
<p>We can calculate the area under the curve (AUC) of the cross K-function. This tells us the two types of cells are:</p>
<ul>
<li>separate clusters - the more negative it is</li>
<li>independent/immune ring - the closer it is to zero</li>
<li>mixed - the more positive it is</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/AUC_of_cross_function.html">AUC_of_cross_function</a></span><span class="op">(</span><span class="va">df_cross</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.07372797</span></code></pre>
<p>The AUC score is close to zero so this tells us that the two types of cells either do not have a relationship or they form a ring surrounding a cluster.</p>
</div>
</div>
<div class="section level2">
<h2 id="localised-entropy-and-spatial-heterogeneity">Localised entropy and spatial heterogeneity<a class="anchor" aria-label="anchor" href="#localised-entropy-and-spatial-heterogeneity"></a>
</h2>
<div class="section level3">
<h3 id="entropy">Entropy<a class="anchor" aria-label="anchor" href="#entropy"></a>
</h3>
<p>We can calculate the entropy of the cells.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_entropy.html">calculate_entropy</a></span><span class="op">(</span><span class="va">formatted_image</span>, cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune1"</span>,<span class="st">"Immune2"</span><span class="op">)</span>, 
                  feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.9294873</span></code></pre>
<p>However, the entropy of one image does not provide us spatial information of the image. We propose the concept of localised entropy, which is calculating an entropy score for a predefined local region. There are two ways to calculate localised entropy. First is a “fish net” approach where the image is split into grid squares and for each square an entropy score is calculated. The other one is a gradient approach where an increasing circle of each reference cell is drawn and a score is calculated for cells within each circle.</p>
<p>Please note that the localised metrics do not only include entropy. Other numeric metrics can also be calculated this way.</p>
</div>
<div class="section level3">
<h3 id="fish-net-grid---spatial-heterogeneity">Fish net grid - spatial heterogeneity<a class="anchor" aria-label="anchor" href="#fish-net-grid---spatial-heterogeneity"></a>
</h3>
<p>One approach to calculate localised metric is to split the image into “fish-net” grid squares. For each grid square, <code>grid_metrics</code> calculate the metric for that square and visualise the raster image. Users can choose any metric as the localised metric. Here we use entropy as an example.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_metrics.html">grid_metrics</a></span><span class="op">(</span><span class="va">defined_image</span>, FUN <span class="op">=</span> <span class="va">calculate_entropy</span>, n_split <span class="op">=</span> <span class="fl">20</span>,
                     cell_types_of_interest<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune3"</span><span class="op">)</span>, 
                     feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-44-1.png" width="700"> After calculating the localised entropy, we can apply metrics like percentages of grid squares with patterns (prevalence) and moran’s I (distinctiveness).</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_percentage_of_grids.html">calculate_percentage_of_grids</a></span><span class="op">(</span><span class="va">grid</span>, threshold <span class="op">=</span> <span class="fl">0.75</span>, above <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 13</span></code></pre>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_spatial_autocorrelaiton.html">calculate_spatial_autocorrelaiton</a></span><span class="op">(</span><span class="va">grid</span>, metric <span class="op">=</span> <span class="st">"globalmoran"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.09446964</span></code></pre>
<p>The selection of threshold depends on the pattern and metric the user chooses to find the localised pattern. We chose 0.75 for entropy because 0.75 is roughly the entropy of two cell types when their ratio is 1:5 or 5:1.</p>
</div>
<div class="section level3">
<h3 id="gradients">Gradients<a class="anchor" aria-label="anchor" href="#gradients"></a>
</h3>
<p>We can use the <code>gradient</code> function to calculate metrics (entropy, mixing score, percentage of cells within radius, marker intensity) for a range of radii. We specify the metric we want to calculate with <code>FUN=</code>. Specifically, we integragted the use of entropy as the metric for graident computation into another function - <code>entropy_gradient_aggregated</code>.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gradient_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">500</span>, <span class="fl">50</span><span class="op">)</span>
<span class="va">gradient_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/entropy_gradient_aggregated.html">entropy_gradient_aggregated</a></span><span class="op">(</span><span class="fu">SPIAT</span><span class="fu">::</span><span class="va">defined_image</span>, cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune3"</span>,<span class="st">"Tumour"</span><span class="op">)</span>,
                                                feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>, radii <span class="op">=</span> <span class="va">gradient_pos</span><span class="op">)</span>
<span class="co"># plot the results</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="va">gradient_results</span><span class="op">$</span><span class="va">gradient_df</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-47-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="tissue-structures">Tissue structures<a class="anchor" aria-label="anchor" href="#tissue-structures"></a>
</h2>
<p>If the image contains tumour, it may be a clear tumour structure or unclear (dispersed). The function <code>average_nearest_neighbor_index</code> can inform us whether there is a clear tumour structure (clustered) or unclear (dispersed), along with a P value for the estimate.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_nearest_neighbor_index.html">average_nearest_neighbor_index</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_cell<span class="op">=</span><span class="st">"Tumour"</span>, 
                               feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span>, p.val <span class="op">=</span> <span class="fl">5e-6</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## $pattern</span>
<span class="co">## [1] "Clustered"</span>
<span class="co">## </span>
<span class="co">## $`p-value`</span>
<span class="co">## [1] 7.11006e-32</span></code></pre>
<p>When there is a clear tumour region in the image, we define four tumour structures: “Inside,” “Outside,” “Infiltration front” and “Invasive front,” as shown in the figure below. Why are we interested in defining such structure? For some types of cancer, there can be small clusters of tumour cells, like globes. We may be interested in not only whether immune cells infiltrate into the whole tumour region but also whether the immune cells infiltrate into the small globes. The identification of the tumour structure can be achieved by calculating the distance from each cell to the tumour boundary, after the identification of bordering cells.</p>
<p>Another way to determine if there is a clear tumour clsuter is using the ratio of tumour bordering cells to tumour total cells. The bordering cells are found by the SPIAT function to be introduced later. If this ratio is high, it means there are too many bordering cells, indicating a not clear tumour cells. And vice versa.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/R_BT.html">R_BT</a></span><span class="op">(</span><span class="va">formatted_image</span>, cell_type_of_interest <span class="op">=</span> <span class="st">"Tumour"</span>, <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-49-1.png" width="700"></p>
<pre><code><span class="co">## [1] 0.2014652</span></code></pre>
<p>The result is 0.2014652. It is a low value which means there are relatively low number of bordering cells compared to total tumour cells. This means the image has clear tumour clusters.</p>
<p><img src="../inst/articles/tumour_structure.png" width="386"></p>
<p>We can identify borders with <code>identify_bordering_cells</code>. This uses the alpha hull method <span class="citation">(Pateiro-Lopez, Rodriguez-Casal, and. 2019)</span> via the <a href="https://github.com/babichmorrowc/hull2spatial" class="external-link">hull2spatial</a> package. Here we use tumour cells (Tumour_marker) as the reference to identify the bordering cells but any cell type can be used.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_border</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_bordering_cells.html">identify_bordering_cells</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                             reference_cell <span class="op">=</span> <span class="st">"Tumour"</span>, 
                                             feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "The alpha of Polygon is: 63.24375"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-51-1.png" width="700"></p>
<p>We then calculate the distance of each cell to the borders.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_distance_to_tumour_margin.html">calculate_distance_to_tumour_margin</a></span><span class="op">(</span><span class="va">formatted_border</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Markers had been selected in pair-wise distance calculation: "</span>
<span class="co">## [1] "Non-border" "Border"</span></code></pre>
<p>We define the area within a 5-cell distance to the boundary as “infiltration front” (inside) and “invasive front” (outside). The areas located more than a 5 cell-distance away from the boundary are defined as “in” (inside) and “out” (outside).</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">names_of_immune_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>,<span class="st">"Immune3"</span><span class="op">)</span>

<span class="va">formatted_structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_structure.html">define_structure</a></span><span class="op">(</span><span class="va">formatted_distance</span>, 
                                        names_of_immune_cells <span class="op">=</span> <span class="va">names_of_immune_cells</span>, 
                                        feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>,
                                        n_margin_layers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "How many layers of cells in the external/internal margin: 5"</span>
<span class="co">## [1] "The width of internal/external margin: 85.0668034976435"</span></code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">categories</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">formatted_structure</span>, <span class="st">"Structure"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Outside"                "Stromal.immune"         "Internal.margin"       </span>
<span class="co">## [4] "Border"                 "External.margin.immune" "Internal.margin.immune"</span>
<span class="co">## [7] "External.margin"        "Inside"                 "Infiltrated.immune"</span></code></pre>
<p>We can plot and colour these structure categories.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">formatted_structure</span>, feature_colname <span class="op">=</span> <span class="st">"Structure"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-54-1.png" width="700"></p>
<p>We can calculate the proportion of immune cells in the tumour structure.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immune_proportions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_proportions_of_cells_in_structure.html">calculate_proportions_of_cells_in_structure</a></span><span class="op">(</span><span class="va">formatted_structure</span>, cell_types_of_interest <span class="op">=</span> <span class="va">names_of_immune_cells</span>, feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span>

<span class="va">immune_proportions</span></code></pre></div>
<pre><code><span class="co">##                Cell.Type                            Relative_to</span>
<span class="co">## 1                Immune1             All_cells_in_the_structure</span>
<span class="co">## 2                Immune2             All_cells_in_the_structure</span>
<span class="co">## 3                Immune3             All_cells_in_the_structure</span>
<span class="co">## 4                Immune1 All_cells_of_interest_in_the_structure</span>
<span class="co">## 5                Immune2 All_cells_of_interest_in_the_structure</span>
<span class="co">## 6                Immune3 All_cells_of_interest_in_the_structure</span>
<span class="co">## 7                Immune1  The_same_cell_type_in_the_whole_image</span>
<span class="co">## 8                Immune2  The_same_cell_type_in_the_whole_image</span>
<span class="co">## 9                Immune3  The_same_cell_type_in_the_whole_image</span>
<span class="co">## 10 All_cells_of_interest             All_cells_in_the_structure</span>
<span class="co">##    P.Infiltrated.Immune P.Internal.Margin.Immune P.External.Margin.Immune</span>
<span class="co">## 1            0.00000000               0.00000000              0.005494505</span>
<span class="co">## 2            0.00000000               0.00000000              0.005494505</span>
<span class="co">## 3            0.14385965               0.08780488              2.159340659</span>
<span class="co">## 4            0.00000000               0.00000000              0.002531646</span>
<span class="co">## 5            0.00000000               0.00000000              0.002531646</span>
<span class="co">## 6            1.00000000               1.00000000              0.994936709</span>
<span class="co">## 7            0.00000000               0.00000000              0.002958580</span>
<span class="co">## 8            0.00000000               0.00000000              0.005617978</span>
<span class="co">## 9            0.06507937               0.05714286              0.623809524</span>
<span class="co">## 10           0.14385965               0.08780488              2.170329670</span>
<span class="co">##    P.Stromal.Immune</span>
<span class="co">## 1        0.11971581</span>
<span class="co">## 2        0.06287744</span>
<span class="co">## 3        0.05683837</span>
<span class="co">## 4        0.50000000</span>
<span class="co">## 5        0.26261128</span>
<span class="co">## 6        0.23738872</span>
<span class="co">## 7        0.99704142</span>
<span class="co">## 8        0.99438202</span>
<span class="co">## 9        0.25396825</span>
<span class="co">## 10       0.23943162</span></code></pre>
<p>We can calculate summaries of the distances for immune cells in the tumour structure.</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immune_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_of_cells_to_borders.html">calculate_summary_distances_of_cells_to_borders</a></span><span class="op">(</span><span class="va">formatted_structure</span>, cell_types_of_interest <span class="op">=</span> <span class="va">names_of_immune_cells</span>, <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning in min(data_of_interest_in$Distance.To.Border): no non-missing arguments</span>
<span class="co">## to min; returning Inf</span></code></pre>
<pre><code><span class="co">## Warning in max(data_of_interest_in$Distance.To.Border): no non-missing arguments</span>
<span class="co">## to max; returning -Inf</span></code></pre>
<pre><code><span class="co">## Warning in min(data_of_interest_in$Distance.To.Border): no non-missing arguments</span>
<span class="co">## to min; returning Inf</span></code></pre>
<pre><code><span class="co">## Warning in max(data_of_interest_in$Distance.To.Border): no non-missing arguments</span>
<span class="co">## to max; returning -Inf</span></code></pre>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immune_distances</span></code></pre></div>
<pre><code><span class="co">##                    Cell.Type       Area    Min_d    Max_d    Mean_d  Median_d</span>
<span class="co">## 1 All_cell_types_of_interest Tumor_area 10.93225 192.4094  86.20042  88.23299</span>
<span class="co">## 2 All_cell_types_of_interest     Stroma 10.02387 984.0509 218.11106 133.18220</span>
<span class="co">## 3                    Immune1 Tumor_area      Inf     -Inf       NaN        NA</span>
<span class="co">## 4                    Immune1     Stroma 84.20018 970.7749 346.14096 301.01535</span>
<span class="co">## 5                    Immune2 Tumor_area      Inf     -Inf       NaN        NA</span>
<span class="co">## 6                    Immune2     Stroma 79.42753 984.0509 333.26374 284.09062</span>
<span class="co">## 7                    Immune3 Tumor_area 10.93225 192.4094  86.20042  88.23299</span>
<span class="co">## 8                    Immune3     Stroma 10.02387 971.5638 102.79227  68.19218</span>
<span class="co">##    St.dev_d</span>
<span class="co">## 1  45.27414</span>
<span class="co">## 2 199.87586</span>
<span class="co">## 3        NA</span>
<span class="co">## 4 187.04247</span>
<span class="co">## 5        NA</span>
<span class="co">## 6 185.67518</span>
<span class="co">## 7  45.27414</span>
<span class="co">## 8 131.32714</span></code></pre>
</div>
<div class="section level2">
<h2 id="clusters-and-communities">Clusters and communities<a class="anchor" aria-label="anchor" href="#clusters-and-communities"></a>
</h2>
<p>The image <code>image_no_markers</code> is simulated from package <code>spaSim</code>. This image contains “Tumour,” “Immune,” “Immune1” and “Immune2” cells without marker intensities.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_no_markers"</span><span class="op">)</span>

<span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">image_no_markers</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune"</span>,<span class="st">"Immune1"</span>,<span class="st">"Immune2"</span>,<span class="st">"Others"</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"blue"</span>,<span class="st">"darkgreen"</span>, <span class="st">"brown"</span>,<span class="st">"lightgray"</span><span class="op">)</span>,<span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-57-1.png" width="700"></p>
<p>We can determine if there are aggregates (or a lack of aggregates) of a particular phenotype or combination of cell types. SPIAT can be used to identify two types of cell aggregates, clusters and communities.</p>
<p>Clusters are cell aggregates composed of non-tumour cells, often by immune cells. For the detection of clusters, <code>identify_cell_clusters</code> only considers cell types of interest defined by the user. Euclidean distances between cells are calculated, and pairs of cells with a distance less than a threshold are considered to be ‘interacting,’ with the rest being ‘non-interacting.’ Hierarchical clustering is then used to separate the clusters. We need to specify a radius. The radius corresponds to how lenient we are in defining clusters. A bigger radius would mean we are more likely to merge individual clusters. The radius is chosen based on what looks ‘reasonable.’ Cells not assigned to clusters (“free” cells) are assigned to Cluster_NA in the output table. The argument <code>min_neighborhood_size</code> specifies the threshold of a neighborhood size to be considered as a neighborhood. Other clustering methods include <em>dbscan</em> and <em>Rphenograph</em>.</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_neighborhoods.html">identify_neighborhoods</a></span><span class="op">(</span><span class="va">image_no_markers</span>, 
                                   method <span class="op">=</span> <span class="st">"hierarchical"</span>,
                                   min_neighborhood_size <span class="op">=</span> <span class="fl">100</span>,
                                   cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span><span class="op">)</span>, 
                                   radius <span class="op">=</span> <span class="fl">50</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-58-1.png" width="700"></p>
<p>This plot shows clusters of Immune, Immune1 and Immune2 cells. Each number and colour corresponds to a distinct cluster. Black cells correspond to ‘free,’ un-clustered cells.</p>
<p>Users are recommended to test out different radius and then visualize the clustering results. But SPIAT also has <code>average_minimum_distance</code>, which calculates the average minimum distance between all cells in an image, and can be used as a starting point.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_minimum_distance.html">average_minimum_distance</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 17.01336</span></code></pre>
<p>We can visualize the cell composition of neighborhoods. This allows us to determine whether there are regions where cells of different types are interacting, or whether there is little mixing between celltypes. To do this, we can use <code>composition_of_neighborhoods</code> to obtain the percentages of cells with a specific marker within each neighborhood and the number of cells in the neighborhood.</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neighorhoods_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/composition_of_neighborhoods.html">composition_of_neighborhoods</a></span><span class="op">(</span><span class="va">clusters</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="va">neighorhoods_vis</span> <span class="op">&lt;-</span> <span class="va">neighorhoods_vis</span><span class="op">[</span><span class="va">neighorhoods_vis</span><span class="op">$</span><span class="va">Total_number_of_cells</span> <span class="op">&gt;=</span><span class="fl">5</span>,<span class="op">]</span></code></pre></div>
<p>Then we can use <code>plot_composition_heatmap</code> to produce a heatmap showing the marker percentages within each cluster.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_composition_heatmap.html">plot_composition_heatmap</a></span><span class="op">(</span><span class="va">neighorhoods_vis</span>, feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-61-1.png" width="700"></p>
<p>This plot shows that Cluster_1 and CLuster_2 contain all three types of immune cells. Cluster_3 does not have Immune1. Cluster_1 and Cluster_2 are more similar to the free cells in their composition.</p>
</div>
<div class="section level2">
<h2 id="reproducibility">Reproducibility<a class="anchor" aria-label="anchor" href="#reproducibility"></a>
</h2>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## R version 4.1.2 (2021-11-01)</span>
<span class="co">## Platform: x86_64-apple-darwin17.0 (64-bit)</span>
<span class="co">## Running under: macOS Big Sur 10.16</span>
<span class="co">## </span>
<span class="co">## Matrix products: default</span>
<span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.0.dylib</span>
<span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib</span>
<span class="co">## </span>
<span class="co">## locale:</span>
<span class="co">## [1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8</span>
<span class="co">## </span>
<span class="co">## attached base packages:</span>
<span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span>
<span class="co">## [8] base     </span>
<span class="co">## </span>
<span class="co">## other attached packages:</span>
<span class="co">##  [1] SPIAT_0.99.0                SingleCellExperiment_1.16.0</span>
<span class="co">##  [3] SummarizedExperiment_1.24.0 Biobase_2.54.0             </span>
<span class="co">##  [5] GenomicRanges_1.46.1        GenomeInfoDb_1.30.1        </span>
<span class="co">##  [7] IRanges_2.28.0              S4Vectors_0.32.3           </span>
<span class="co">##  [9] BiocGenerics_0.40.0         MatrixGenerics_1.6.0       </span>
<span class="co">## [11] matrixStats_0.61.0          BiocStyle_2.22.0           </span>
<span class="co">## </span>
<span class="co">## loaded via a namespace (and not attached):</span>
<span class="co">##   [1] circlize_0.4.14        systemfonts_1.0.4      plyr_1.8.6            </span>
<span class="co">##   [4] lazyeval_0.2.2         sp_1.4-6               splines_4.1.2         </span>
<span class="co">##   [7] crosstalk_1.2.0        ggplot2_3.3.5          elsa_1.1-28           </span>
<span class="co">##  [10] digest_0.6.29          foreach_1.5.2          htmltools_0.5.2       </span>
<span class="co">##  [13] fansi_1.0.2            magrittr_2.0.2         memoise_2.0.1         </span>
<span class="co">##  [16] cluster_2.1.2          tensor_1.5             doParallel_1.0.17     </span>
<span class="co">##  [19] tzdb_0.2.0             tripack_1.3-9.1        ComplexHeatmap_2.10.0 </span>
<span class="co">##  [22] R.utils_2.11.0         vroom_1.5.7            pkgdown_2.0.2         </span>
<span class="co">##  [25] spatstat.sparse_2.1-0  colorspace_2.0-3       ggrepel_0.9.1         </span>
<span class="co">##  [28] textshaping_0.3.6      xfun_0.30              dplyr_1.0.8           </span>
<span class="co">##  [31] rgdal_1.5-28           crayon_1.5.0           RCurl_1.98-1.6        </span>
<span class="co">##  [34] jsonlite_1.8.0         spatstat_2.3-3         spatstat.data_2.1-2   </span>
<span class="co">##  [37] iterators_1.0.14       glue_1.6.2             polyclip_1.10-0       </span>
<span class="co">##  [40] gtable_0.3.0           zlibbioc_1.40.0        XVector_0.34.0        </span>
<span class="co">##  [43] GetoptLong_1.0.5       DelayedArray_0.20.0    shape_1.4.6           </span>
<span class="co">##  [46] apcluster_1.4.9        abind_1.4-5            scales_1.1.1          </span>
<span class="co">##  [49] sgeostat_1.0-27        pheatmap_1.0.12        spatstat.random_2.1-0 </span>
<span class="co">##  [52] Rcpp_1.0.8             viridisLite_0.4.0      clue_0.3-60           </span>
<span class="co">##  [55] spatstat.core_2.4-0    bit_4.0.4              dittoSeq_1.6.0        </span>
<span class="co">##  [58] htmlwidgets_1.5.4      httr_1.4.2             RColorBrewer_1.1-2    </span>
<span class="co">##  [61] ellipsis_0.3.2         pkgconfig_2.0.3        R.methodsS3_1.8.1     </span>
<span class="co">##  [64] farver_2.1.0           sass_0.4.0             deldir_1.0-6          </span>
<span class="co">##  [67] alphahull_2.2          utf8_1.2.2             tidyselect_1.1.2      </span>
<span class="co">##  [70] labeling_0.4.2         rlang_1.0.2            reshape2_1.4.4        </span>
<span class="co">##  [73] munsell_0.5.0          tools_4.1.2            cachem_1.0.6          </span>
<span class="co">##  [76] cli_3.2.0              dbscan_1.1-10          generics_0.1.2        </span>
<span class="co">##  [79] splancs_2.01-42        mmand_1.6.1            ggridges_0.5.3        </span>
<span class="co">##  [82] evaluate_0.15          stringr_1.4.0          fastmap_1.1.0         </span>
<span class="co">##  [85] yaml_2.3.5             ragg_1.2.2             goftest_1.2-3         </span>
<span class="co">##  [88] knitr_1.37             bit64_4.0.5            fs_1.5.2              </span>
<span class="co">##  [91] purrr_0.3.4            RANN_2.6.1             nlme_3.1-153          </span>
<span class="co">##  [94] R.oo_1.24.0            pracma_2.3.8           compiler_4.1.2        </span>
<span class="co">##  [97] rstudioapi_0.13        plotly_4.10.0          png_0.1-7             </span>
<span class="co">## [100] spatstat.utils_2.3-0   spatstat.linnet_2.3-2  tibble_3.1.6          </span>
<span class="co">## [103] bslib_0.3.1            stringi_1.7.6          highr_0.9             </span>
<span class="co">## [106] desc_1.4.1             lattice_0.20-45        Matrix_1.3-4          </span>
<span class="co">## [109] vctrs_0.3.8            pillar_1.7.0           lifecycle_1.0.1       </span>
<span class="co">## [112] BiocManager_1.30.16    GlobalOptions_0.1.2    spatstat.geom_2.3-2   </span>
<span class="co">## [115] jquerylib_0.1.4        data.table_1.14.2      cowplot_1.1.1         </span>
<span class="co">## [118] bitops_1.0-7           raster_3.5-15          R6_2.5.1              </span>
<span class="co">## [121] bookdown_0.24          gridExtra_2.3          codetools_0.2-18      </span>
<span class="co">## [124] gtools_3.9.2           rjson_0.2.21           rprojroot_2.0.2       </span>
<span class="co">## [127] GenomeInfoDbData_1.2.7 mgcv_1.8-38            parallel_4.1.2        </span>
<span class="co">## [130] terra_1.5-21           grid_4.1.2             rpart_4.1-15          </span>
<span class="co">## [133] tidyr_1.2.0            rmarkdown_2.12         Rtsne_0.15</span></code></pre>
</div>
<div class="section level2">
<h2 id="author-contributions">Author Contributions<a class="anchor" aria-label="anchor" href="#author-contributions"></a>
</h2>
<p>AT, YF, TY, ML, JZ, VO, MD are authors of the package code. MD and YF wrote the vignette. AT designed the package.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-keren2018structured" class="csl-entry">
Keren, Leeat, Marc Bosse, Diana Marquez, Roshan Angoshtari, Samir Jain, Sushama Varma, Soo-Ryum Yang, et al. 2018. <span>“A Structured Tumor-Immune Microenvironment in Triple Negative Breast Cancer Revealed by Multiplexed Ion Beam Imaging.”</span> <em>Cell</em> 174 (6): 1373–87.
</div>
<div id="ref-alphahull" class="csl-entry">
Pateiro-Lopez, Beatriz, Alberto Rodriguez-Casal, and. 2019. <em>Alphahull: Generalization of the Convex Hull of a Sample of Points in the Plane</em>. <a href="https://CRAN.R-project.org/package=alphahull" class="external-link">https://CRAN.R-project.org/package=alphahull</a>.
</div>
<div id="ref-yang2020spiat" class="csl-entry">
Yang, Tianpei, Volkan Ozcoban, Anu Pasam, Nikolce Kocovski, Angela Pizzolla, Yu-Kuan Huang, Greg Bass, et al. 2020. <span>“SPIAT: An r Package for the Spatial Image Analysis of Cells in Tissues.”</span> <em>bioRxiv</em>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Anna Trigos, Yuzhou Feng, Tom Yang, Mabel Li, John Zhu, Volkan Ozcoban, Maria Doyle.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
