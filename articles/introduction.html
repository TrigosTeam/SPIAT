<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SPIAT">
<title>Overview of the SPIAT package • SPIAT</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Overview of the SPIAT package">
<meta property="og:description" content="SPIAT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SPIAT</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Overview of the SPIAT package</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/trigosteam/SPIAT/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Overview of the SPIAT package</h1>
                        <h4 data-toc-skip class="author">Anna Trigos, Yuzhou Feng, Tianpei Yang, Mabel Li, John Zhu, Volkan Ozcoban, Maria Doyle</h4>
            
            <h4 data-toc-skip class="date">24 May 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/trigosteam/SPIAT/blob/HEAD/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="basics">Basics<a class="anchor" aria-label="anchor" href="#basics"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>SPIAT (<strong>Sp</strong>atial <strong>I</strong>mage <strong>A</strong>nalysis of <strong>T</strong>issues) is an R package with a suite of data processing, quality control, visualization, data handling and data analysis tools. SPIAT is compatible with data generated from single-cell spatial proteomics platforms (e.g. OPAL, CODEX, MIBI). SPIAT reads spatial data in the form of X and Y coordinates of cells, marker intensities and cell phenotypes.</p>
<p>SPIAT includes six analysis modules that allow visualization, calculation of cell colocalization, categorization of the immune microenvironment relative to tumor areas, analysis of cellular neighborhoods, and the quantification of spatial heterogeneity, providing a comprehensive toolkit for spatial data analysis.</p>
<p>An overview of the functions available is shown in the figure below.</p>
<p><img src="SPIAT-overview.jpg" width="85%"></p>
</div>
<div class="section level3">
<h3 id="installing-spiat">Installing <code>SPIAT</code><a class="anchor" aria-label="anchor" href="#installing-spiat"></a>
</h3>
<p><em><a href="https://bioconductor.org/packages/3.15/SPIAT" class="external-link">SPIAT</a></em> is a <code>R</code> package available via the <a href="http://bioconductor.org" class="external-link">Bioconductor</a> repository for packages. You can install the lasted development version from Github. You can install SPIAT using the following commands in your <code>R</code> session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Check that you have a valid Bioconductor installation</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/valid.html" class="external-link">valid</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span>
  <span class="op">}</span>

<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"SPIAT"</span><span class="op">)</span>

<span class="co">## install from GitHub</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span> <span class="co"># if you don't have devtools installed</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"TrigosTeam/SPIAT"</span>, ref <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="citing-spiat">Citing <code>SPIAT</code><a class="anchor" aria-label="anchor" href="#citing-spiat"></a>
</h3>
<p>We hope that <em><a href="https://bioconductor.org/packages/3.15/SPIAT" class="external-link">SPIAT</a></em> will be useful for your research. Please use the following information to cite the package and the overall approach. Thank you!</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Citation info</span>
<span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"SPIAT"</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; To cite package 'SPIAT' in publications use:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   Trigos A, Feng Y, Yang T, Li M, Zhu J, Ozcoban V, Doyle M (2022).</span>
<span class="co">#&gt;   _SPIAT: Spatial Image Analysis of Cells in Tissues_. R package</span>
<span class="co">#&gt;   version 0.99.0, &lt;https://trigosteam.github.io/SPIAT/&gt;.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   Yang T, Ozcoban V, Pasam A, Kocovski N, Pizzolla A, Huang Y, Bass G,</span>
<span class="co">#&gt;   Keam S, Neeson P, Sandhu S, Goode D, Trigos A (2020). "SPIAT: An R</span>
<span class="co">#&gt;   package for the Spatial Image Analysis of Cells in Tissues."</span>
<span class="co">#&gt;   _bioRxiv_. doi:10.1101/2020.05.28.122614</span>
<span class="co">#&gt;   &lt;https://doi.org/10.1101/2020.05.28.122614&gt;.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; To see these entries in BibTeX format, use 'print(&lt;citation&gt;,</span>
<span class="co">#&gt; bibtex=TRUE)', 'toBibtex(.)', or set</span>
<span class="co">#&gt; 'options(citation.bibtex.max=999)'.</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="tutorial">Tutorial<a class="anchor" aria-label="anchor" href="#tutorial"></a>
</h2>
<div class="section level3">
<h3 id="reading-in-data-and-basic-data-formatting-in-spiat">Reading in data and basic data formatting in SPIAT<a class="anchor" aria-label="anchor" href="#reading-in-data-and-basic-data-formatting-in-spiat"></a>
</h3>
<p>First we load the SPIAT library.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://trigosteam.github.io/SPIAT/">SPIAT</a></span><span class="op">)</span></code></pre></div>
<p><code>format_image_to_sce</code> is the main function to read in data to SPIAT.<code>format_image_to_sce</code> creates a SingleCellExperiment object which is used in all subsequent functions. The key data points of interest for SPIAT are cell coordinates, marker intensities and cell phenotypes for each cell.</p>
<p><code>format_image_to_sce</code> has specific options to read in data generated from InForm, HALO, Visium 10X Genomics, CODEX and cell profiler. However, we advice pre-formatting the data before input to SPIAT to that accepted by the ‘general’ option (shown below). This is due to often inconsistencies in the column names or data formats across different versions or as a result of different user options when using the other platforms.</p>
<div class="section level4">
<h4 id="reading-in-data-through-the-general-option-recommended">Reading in data through the ‘general’ option (RECOMMENDED)<a class="anchor" aria-label="anchor" href="#reading-in-data-through-the-general-option-recommended"></a>
</h4>
<p>Format “general” allows you to input a matrix of intensities (<code>intensity_matrix</code>), and a vector of <code>phenotypes</code>, which should be in the same order in which they appear in the intensity_matrix. They must be of the form of marker combinations (e.g. “CD3,CD8”), as opposed to cell names (e.g. “cytotoxic T cells”), as SPIAT does matching with the marker names. If no phenotypes are available, then a vector of NA can be used as input. You also need to provide seperate vectors with the X and Y coordinates of the cells (<code>coord_x</code> and <code>coord_y</code>). The cells must be in the same order as in the intensity_matrix. If you have Xmin, Xmax, Ymin and Ymax columns, we advise calculating the average to obtain a single X and Y coordinate, which you can then use as input to <code>coord_x</code> and <code>coord_y</code>.</p>
<p>Here we use some dummy data to illustrate how to read “general” format.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Construct a dummy marker intensity matrix</span>
<span class="co">## rows are markers, columns are cells</span>
<span class="va">intensity_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">14.557</span>, <span class="fl">0.169</span>, <span class="fl">1.655</span>, <span class="fl">0.054</span>,
                             <span class="fl">17.588</span>, <span class="fl">0.229</span>, <span class="fl">1.188</span>, <span class="fl">2.074</span>, 
                             <span class="fl">21.262</span>, <span class="fl">4.206</span>,  <span class="fl">5.924</span>, <span class="fl">0.021</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="co"># define marker names as rownames</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"CD4"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="co"># define cell IDs as colnames</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cell_1"</span>, <span class="st">"Cell_2"</span>, <span class="st">"Cell_3"</span><span class="op">)</span> 

<span class="co"># Construct a dummy metadata (phenotypes, x/y coordinates)</span>
<span class="co"># the order of the elements in these vectors correspond to the cell order </span>
<span class="co"># in `intensity matrix`</span>
<span class="va">phenotypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"OTHER"</span>,  <span class="st">"AMACR"</span>, <span class="st">"CD3,CD4"</span><span class="op">)</span>
<span class="va">coord_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">82</span>, <span class="fl">171</span>, <span class="fl">184</span><span class="op">)</span>
<span class="va">coord_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">22</span>, <span class="fl">38</span><span class="op">)</span>

<span class="va">general_format_image</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"general"</span>, intensity_matrix <span class="op">=</span> <span class="va">intensity_matrix</span>,
                    phenotypes <span class="op">=</span> <span class="va">phenotypes</span>, coord_x <span class="op">=</span> <span class="va">coord_x</span>, coord_y <span class="op">=</span> <span class="va">coord_y</span><span class="op">)</span>
<span class="co">#&gt; Note: 4 rows removed due to NA intensity values.</span></code></pre></div>
<p>The formatted image now contains phenotypes location and marker intensity information of 3 cells. Note that if users want to define cell IDs, the cell IDs should be defined as the colnames of the intensity matrix. The order of the rows of the metadata should correspond to the order of the colnames of the intensity matrix. The function will automatically assign rownames to the metadata.</p>
<p>Use the following codes to inspect the information.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># metadata</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">general_format_image</span><span class="op">)</span>
<span class="co">#&gt; DataFrame with 3 rows and 3 columns</span>
<span class="co">#&gt;          Phenotype Cell.X.Position Cell.Y.Position</span>
<span class="co">#&gt;        &lt;character&gt;       &lt;numeric&gt;       &lt;numeric&gt;</span>
<span class="co">#&gt; Cell_1       OTHER              82              30</span>
<span class="co">#&gt; Cell_2       AMACR             171              22</span>
<span class="co">#&gt; Cell_3     CD3,CD4             184              38</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># marker intensities</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">general_format_image</span><span class="op">)</span>
<span class="co">#&gt;       Cell_1 Cell_2 Cell_3</span>
<span class="co">#&gt; DAPI  14.557 17.588 21.262</span>
<span class="co">#&gt; CD3    0.169  0.229  4.206</span>
<span class="co">#&gt; CD4    1.655  1.188  5.924</span>
<span class="co">#&gt; AMACR  0.054  2.074  0.021</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="reading-in-data-pre-formatted-by-other-software">Reading in data pre-formatted by other software<a class="anchor" aria-label="anchor" href="#reading-in-data-pre-formatted-by-other-software"></a>
</h4>
<p>If you prefer to use data directly generated from InForm, HALO, Visium, CODEX and cellprofiler, these can be specified as options in <code>format_image_to_sce</code>.</p>
<p>For reading in input generated with Visium, CODEX or cellprofiler see the help (<code><a href="../reference/format_image_to_sce.html">?format_image_to_sce</a></code>).</p>
<div class="section level5">
<h5 id="reading-in-data-from-inform">Reading in data from InForm<a class="anchor" aria-label="anchor" href="#reading-in-data-from-inform"></a>
</h5>
<p>To read in data from InForm, you need the table file generated by InForm, the list of markers of interest, and their location in the cell. <code>format_image_to_sce</code> uses the Cell X Position and Cell Y Position columns and the Phenotype column in the InForm raw data. The phenotype of a cell can be a single marker, for example, “CD3”, or a combination of markers, such as “CD3,CD4”. As a convention, SPIAT assumes that cells marked as “OTHER” refer to cells positive for DAPI but no other marker. The phenotypes must be based on the markers (e.g. CD3,CD4), rather than names of cells (e.g. cytotoxic T cells). The names of the cells can be added later using the <code>define_celltypes</code> function. The following cell properties columns are also required to be present in the InForm input file: Entire Cell Area (pixels), Nucleus Area (pixels), Nucleus Compactness, Nucleus Axis Ratio, and Entire Cell Axis Ratio. If not present in the users’ data, these can be columns with NAs.</p>
<p>To read in InForm data, you need to specify the following parameters:</p>
<ul>
<li>
<code>format</code>: “INFORM”</li>
<li>
<code>path</code>: path to the raw InForm image data file</li>
<li>
<code>markers</code>: names of markers used in the OPAL staining. These must be in the same order as the marker columns in the input file, and for InForm must match the marker name used in the input file. One of the markers must be DAPI.</li>
<li>
<code>locations</code>: locations of the markers in cells, either Nucleus, Cytoplasm or Membrane. These must be in the order of the markers. The locations are used to auto-detect the intensity (and dye) columns.</li>
</ul>
<p>A small example of InForm input is included in SPIAT containing dummy marker intensity values and all the other required columns (see below). This example file is just for demonstrating importing a raw data file, later in the <a href="#example-data">Example data</a> section we will load a larger preformatted dataset. Users are welcome to use this formatting option if it is closer to the format of their files.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">raw_inform_data</span><span class="op">)</span>
<span class="co">#&gt; [1] "/home/runner/work/_temp/Library/SPIAT/extdata/tiny_inform.txt.gz"</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PD-L1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nucleus"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Membrane"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span>, <span class="st">"Cytoplasm"</span><span class="op">)</span> <span class="co">#maybe you no longer need this if we are using the general format?</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          path<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          locations<span class="op">=</span><span class="va">locations</span><span class="op">)</span></code></pre></div>
<p>Alternatively, rather than specifying the <code>locations</code>, you can also specify the specific intensity columns with <code>intensity_columns_interest</code> as shown below.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_inform_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_inform.txt.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PD-L1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
  <span class="st">"Nucleus DAPI (DAPI) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD3 (Opal 520) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Membrane PD-L1 (Opal 540) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD4 (Opal 620) Mean (Normalized Counts, Total Weighting)"</span>,
  <span class="st">"Cytoplasm CD8 (Opal 650) Mean (Normalized Counts, Total Weighting)"</span>, 
  <span class="st">"Cytoplasm AMACR (Opal 690) Mean (Normalized Counts, Total Weighting)"</span>
  <span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"INFORM"</span>,
                          path<span class="op">=</span><span class="va">raw_inform_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                    intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span> <span class="co"># The formatted image is a SingleCellExperiment object</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="reading-in-data-from-halo">Reading in data from HALO<a class="anchor" aria-label="anchor" href="#reading-in-data-from-halo"></a>
</h5>
<p>To read in data from HALO, you need the table file generated by HALO, which lists marker intensities. The biggest difference between InForm and HALO formats is the coding of the cell phenotypes. While InForm encodes phenotypes as the combination of positive markers (e.g. “CD3,CD4”), HALO uses a binary system of 1 if the cell is positive for the marker and 0 otherwise.</p>
<p><code>format_image_to_sce</code> collapses HALO encoded phenotypes into an INFORM-like format to create the Phenotype column. For example, if HALO has assigned a cell a marker status of 1 for CD3 and 1 for CD4, SPIAT will give it the Phenotype “CD3,CD4”. Cells that have a marker status of 1 for DAPI but no other marker, are given the phenotype “OTHER”.</p>
<p><code>format_image_to_sce</code> takes the average of the HALO X min and X max columns for each cell to create the Cell.X.Position column. It takes the average of the Y min and Y max to create the Cell.Y.Position column.</p>
<p>To read in HALO data, you need to specify the following parameters:</p>
<ul>
<li>
<code>format</code>: “HALO”</li>
<li>
<code>path</code>: path to the raw HALO image data file</li>
<li>
<code>markers</code>: names of markers used in the OPAL staining. These must be in the same order as the marker columns in the input file, and for HALO must match the marker name used in the input file. One of the markers must be DAPI.</li>
<li>
<code>locations</code>: locations of the markers in cells, either Nucleus, Cytoplasm or Membrane. These must be in the order of the markers. The locations are used to auto-detect the intensity (and dye) columns.</li>
</ul>
<p>Users can specify the <code>locations</code> to auto-detect the columns as shown above for InForm. Alternatively, if users want to specify the columns instead, you can do so with <code>intensity_columns_interest</code>, as shown in the example below. Note that then you also must specify the <code>dye_columns_interest</code>. The following cell properties columns are also required to be present in the HALO input file: Cell Area, Nucleus Area, Cytoplasm Area. If these are not present in the user’s data, we recommend adding these columns with NA values.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_halo_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"tiny_halo.csv.gz"</span>, package <span class="op">=</span> <span class="st">"SPIAT"</span><span class="op">)</span>
<span class="va">markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DAPI"</span>, <span class="st">"CD3"</span>, <span class="st">"PDL-1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"AMACR"</span><span class="op">)</span>
<span class="va">intensity_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dye 1 Nucleus Intensity"</span>,
                                <span class="st">"Dye 2 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 3 Membrane Intensity"</span>,
                                <span class="st">"Dye 4 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 5 Cytoplasm Intensity"</span>,
                                <span class="st">"Dye 6 Cytoplasm Intensity"</span><span class="op">)</span>
<span class="va">dye_columns_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dye 1 Positive Nucleus"</span>,
                          <span class="st">"Dye 2 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 3 Positive Membrane"</span>,
                          <span class="st">"Dye 4 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 5 Positive Cytoplasm"</span>,
                          <span class="st">"Dye 6 Positive Cytoplasm"</span><span class="op">)</span>
<span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_image_to_sce.html">format_image_to_sce</a></span><span class="op">(</span>
                          format<span class="op">=</span><span class="st">"HALO"</span>,
                          path<span class="op">=</span><span class="va">raw_halo_data</span>,
                          markers<span class="op">=</span><span class="va">markers</span>,
                          intensity_columns_interest<span class="op">=</span><span class="va">intensity_columns_interest</span>,
                          dye_columns_interest<span class="op">=</span><span class="va">dye_columns_interest</span>
                          <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span> <span class="co"># The formatted image is a SingleCellExperiment object</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">formatted_image</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="inspecting-the-singelcellexperiment-object">Inspecting the SingelCellExperiment object<a class="anchor" aria-label="anchor" href="#inspecting-the-singelcellexperiment-object"></a>
</h3>
<div class="section level4">
<h4 id="example-data">Structure of a SPIAT SingleCellExperiment object<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h4>
<p>In this vignette we will use an InForm data file that’s already been formatted for SPIAT with <code>format_image_to_sce</code>, which we can load with <code>data</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"simulated_image"</span><span class="op">)</span></code></pre></div>
<p>This is <em>SingleCellExperiment</em> format.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span>
<span class="co">#&gt; [1] "SingleCellExperiment"</span>
<span class="co">#&gt; attr(,"package")</span>
<span class="co">#&gt; [1] "SingleCellExperiment"</span></code></pre></div>
<p>This example data has 5 markers and 4951 cells.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span>
<span class="co">#&gt; [1]    5 4951</span></code></pre></div>
<p><code>assay</code> stores the intensity level of every marker (rows) for every cell (columns).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 columns</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt;                      Cell_1       Cell_2      Cell_3       Cell_4       Cell_5</span>
<span class="co">#&gt; Tumour_marker  4.466925e-01 1.196802e-04 0.235435887 1.125552e-01 1.600443e-02</span>
<span class="co">#&gt; Immune_marker1 1.143640e-05 4.360881e-19 0.120582510 2.031554e-13 1.685832e-01</span>
<span class="co">#&gt; Immune_marker2 1.311175e-15 5.678623e-02 0.115769761 5.840184e-12 9.025254e-05</span>
<span class="co">#&gt; Immune_marker3 6.342341e-09 2.862823e-06 0.053107792 6.289501e-04 4.912962e-13</span>
<span class="co">#&gt; Immune_marker4 2.543406e-04 4.702311e-04 0.005878394 4.582812e-03 2.470984e-03</span></code></pre></div>
<p><code>colData</code> stores the phenotype, x and y coordinates, and the cell properties.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take a look at first 5 rows</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">simulated_image</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span>
<span class="co">#&gt; DataFrame with 5 rows and 3 columns</span>
<span class="co">#&gt;          Phenotype Cell.X.Position Cell.Y.Position</span>
<span class="co">#&gt;        &lt;character&gt;       &lt;numeric&gt;       &lt;numeric&gt;</span>
<span class="co">#&gt; Cell_1       OTHER        139.7748         86.7041</span>
<span class="co">#&gt; Cell_2       OTHER         77.8672         80.0965</span>
<span class="co">#&gt; Cell_3       OTHER         84.4463         19.2386</span>
<span class="co">#&gt; Cell_4       OTHER        110.1986          5.6560</span>
<span class="co">#&gt; Cell_5       OTHER        167.8956        171.9264</span></code></pre></div>
<p>We can check what phenotypes are present with <code>print_feature</code>, which will print any specified column in the data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">simulated_image</span>, feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span>
<span class="co">#&gt; [1] "OTHER"                                       </span>
<span class="co">#&gt; [2] "Immune_marker1,Immune_marker2"               </span>
<span class="co">#&gt; [3] "Tumour_marker"                               </span>
<span class="co">#&gt; [4] "Immune_marker1,Immune_marker2,Immune_marker4"</span>
<span class="co">#&gt; [5] "Immune_marker1,Immune_marker3"</span></code></pre></div>
<p>The phenotypes in this example data can be interpreted as follows:</p>
<p>Tumour_marker = cancer cells Immune_marker1,Immune_marker2 = immune cell type 1 Immune_marker1,Immune_marker3 = immune cell type 2 Immune_marker1,Immune_marker2,Immune_marker4 = immune cell type 3 OTHER = other cell types</p>
</div>
<div class="section level4">
<h4 id="nomenclature">Nomenclature<a class="anchor" aria-label="anchor" href="#nomenclature"></a>
</h4>
<p>In SPIAT We define as <strong>markers</strong> as proteins whose levels where queried by OPAL, CODEX or another platform.</p>
<p>Examples of markers are “AMACR” for prostate cancer cells, “panCK” for epithelial tumor cells, “CD3” for T cells or “CD20” for B cells.</p>
<p>The combination of markers results in a specific <strong>cell phenotype</strong>. For example, a cell positive for both “CD3” and “CD4” markers has the “CD3,CD4” <strong>cell phenotype</strong>.</p>
<p>Finally, we define a <strong>cell type</strong> as a name assigned by the user to a cell phenotype. For example, a user can name “CD3,CD4” cells as “helper T cells”. We would refer to “helper T cells” therefore as a <strong>cell type</strong>.</p>
</div>
<div class="section level4">
<h4 id="splitting-images">Splitting images<a class="anchor" aria-label="anchor" href="#splitting-images"></a>
</h4>
<p>In the case of large images, or images where there are two independent tissue sections, it is recommended to split images into sections defined by the user. This can be performed with <code>image_splitter</code> after <code>format_image_to_sce</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/image_splitter.html">image_splitter</a></span><span class="op">(</span><span class="va">simulated_image</span>, number_of_splits<span class="op">=</span><span class="fl">3</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="predicting-cell-phenotypes">Predicting cell phenotypes<a class="anchor" aria-label="anchor" href="#predicting-cell-phenotypes"></a>
</h4>
<p>SPIAT can predict cell phenotypes using marker intensity levels with <code>predict_phenotypes</code>. This can be used to check the phenotypes that have been assigned by InForm and HALO. It can also potentially be used to automate the manual phenotypying performed with InForm/HALO. The underlying algorithm is based on the density distribution of marker intensities. We have found this algorithm to perform best in OPAL data, as well as for identifying clearly distinct cell types from MIBI and CODEX datasets. This algorithm does not take into account cell shape or size, so if these are required for phenotyping, using HALO or InForm or a machine-learning best method is recommended.</p>
<p><code>predict_phenotypes</code> produces a density plot that shows the cutoff for calling a cell positive for a marker. If the dataset includes phenotypes obtained through another software, this function prints to the console the concordance between SPIAT’s prediction and pre-defined phenotypes as the number of true positives (TP), true negatives (TN), false positives (FP) and false negatives (FN) phenotype assignments. It returns a table containing the phenotypes predicted by SPIAT and the actual phenotypes from InForm/HALO (if available).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_phenotypes.html">predict_phenotypes</a></span><span class="op">(</span>sce_object <span class="op">=</span> <span class="va">simulated_image</span>,
                                      thresholds <span class="op">=</span> <span class="cn">NULL</span>,
                                      tumour_marker <span class="op">=</span> <span class="st">"Tumour_marker"</span>,
                                      baseline_markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune_marker1"</span>, <span class="st">"Immune_marker2"</span>, <span class="st">"Immune_marker3"</span>, <span class="st">"Immune_marker4"</span><span class="op">)</span>,
                                      reference_phenotypes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; [1] "Tumour_marker"</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-1.png" width="60%"></p>
<pre><code><span class="co">#&gt; [1] "Immune_marker1"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-2.png" width="60%"></p>
<pre><code><span class="co">#&gt; [1] "Immune_marker2"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-3.png" width="60%"></p>
<pre><code><span class="co">#&gt; [1] "Immune_marker3"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-4.png" width="60%"></p>
<pre><code><span class="co">#&gt; [1] "Immune_marker4"</span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-16-5.png" width="60%"></p>
<p>We can use <code>marker_prediction_plot</code> to plot the predicted cell phenotypes and the ones obtained using HALO or InForm, for comparison.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_prediction_plot.html">marker_prediction_plot</a></span><span class="op">(</span><span class="va">predicted_image</span>, marker<span class="op">=</span><span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-17-1.png" width="100%"></p>
<p>The plot shows Immune_marker1+ cells in the tissue. On the left are the Immune_marker1+ cells defined by InForm and on the right are the Immune_marker1+ cells predicted using SPIAT. If this is simulated data, then there are no cells defined by InForm. We can say that on the left we have the phenotypes we had pre-defined and leave it at that.</p>
<p>The next example shows how to replace the original phenotypes with the predicted ones. Note that for this tutorial, we still use the original phenotypes.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_phenotypes.html">predict_phenotypes</a></span><span class="op">(</span>sce_object <span class="op">=</span> <span class="va">simulated_image</span>,
                                      thresholds <span class="op">=</span> <span class="cn">NULL</span>,
                                      tumour_marker <span class="op">=</span> <span class="st">"Tumour_marker"</span>,
                                      baseline_markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune_marker1"</span>, <span class="st">"Immune_marker2"</span>, <span class="st">"Immune_marker3"</span>, <span class="st">"Immune_marker4"</span><span class="op">)</span>,
                                      reference_phenotypes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="specifying-cell-types">Specifying cell types<a class="anchor" aria-label="anchor" href="#specifying-cell-types"></a>
</h4>
<p>SPIAT can define cell types with the <code>define_celltypes</code> function. By default the column is called Cell.Type. Note that this needs to be specified by the user.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_celltypes.html">define_celltypes</a></span><span class="op">(</span><span class="va">simulated_image</span>, 
                                    categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>, <span class="st">"Immune_marker1,Immune_marker3"</span>, 
                                                   <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span>, <span class="st">"OTHER"</span><span class="op">)</span>, 
                                    category_colname <span class="op">=</span> <span class="st">"Phenotype"</span>,
                                    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>, 
                                              <span class="st">"Immune3"</span>, <span class="st">"Others"</span><span class="op">)</span>,
                                    new_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="quality-control">Quality control<a class="anchor" aria-label="anchor" href="#quality-control"></a>
</h3>
<p>Here we present some quality control steps implemented in SPIAT to check for the quality of phenotyping, help detect uneven staining, and other potential technical artefacts.</p>
<div class="section level4">
<h4 id="boxplots-of-marker-intensities">Boxplots of marker intensities<a class="anchor" aria-label="anchor" href="#boxplots-of-marker-intensities"></a>
</h4>
<p>Phenotyping of cells can be verified comparing marker intensities of cells labelled positive and negative for a marker. Cells positive for a marker should have high levels of the marker. An unclear separation of marker intensities between positive and negative cells would suggest phenotypes have not been accurately assigned. We can use <code>marker_intensity_boxplot</code> to produce a boxplot for cells phenotyped as being positive or negative for a marker.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_intensity_boxplot.html">marker_intensity_boxplot</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-21-1.png" width="60%"></p>
<p>Note that if phenotypes were obtained from software that uses machine learning to determine positive cells, which generally also take into account properties such as cell shape, nucleus size etc., rather than a strict threshold, some negative cells will have high marker intensities, and vice versa. In general, a limited overlap of whiskers or outlier points is tolerated and expected. However, overlapping boxplots suggests unreliable phenotyping.</p>
</div>
<div class="section level4">
<h4 id="scatter-plots-of-marker-levels">Scatter plots of marker levels<a class="anchor" aria-label="anchor" href="#scatter-plots-of-marker-levels"></a>
</h4>
<p>Uneven marker staining or high background intensity can be identified with <code>plot_cell_marker_levels</code>. This produces a scatter plot of the intensity of a marker in each cell. This should be relatively even across the image and all phenotyped cells. Cells that were not phenotyped as being positive for the particular marker are excluded.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_marker_levels.html">plot_cell_marker_levels</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-22-1.png" width="100%"></p>
</div>
<div class="section level4">
<h4 id="heatmaps-of-marker-levels">Heatmaps of marker levels<a class="anchor" aria-label="anchor" href="#heatmaps-of-marker-levels"></a>
</h4>
<p>For large images, there is also the option of ‘blurring’ the image, where the image is split into multiple small areas, and marker intensities are averaged within each. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_marker_level_heatmap.html">plot_marker_level_heatmap</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits <span class="op">=</span> <span class="fl">100</span>, <span class="st">"Tumour_marker"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-23-1.png" width="75%"></p>
</div>
<div class="section level4">
<h4 id="identifying-incorrect-phenotypes">Identifying incorrect phenotypes<a class="anchor" aria-label="anchor" href="#identifying-incorrect-phenotypes"></a>
</h4>
<p>We may see cells with biologically implausible combination of markers present n the input data when using <code>print_feature</code>. For example, cells might be incorrectly typed as positive for two markers that known to not co-occur in a single cell type. Incorrect cell phenotypes may be present due to low cell segmentation quality, antibody ‘bleeding’ from one cell to another or inadequate marker thresholding.</p>
<p>If the number of incorrectly phenotyped cells is small (&lt;5%), we advise simply removing these cells (see below). If it is a higher proportion, we recommend checking the cell segmentation and phenotyping methods, as a more systematic problem might be present.</p>
</div>
<div class="section level4">
<h4 id="removing-cells-with-incorrect-phenotypes">Removing cells with incorrect phenotypes<a class="anchor" aria-label="anchor" href="#removing-cells-with-incorrect-phenotypes"></a>
</h4>
<p>If you identify incorrect phenotypes or have any you want to exclude you can use <code>select_phenotypes</code>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_celltypes.html">select_celltypes</a></span><span class="op">(</span><span class="va">formatted_image</span>, keep<span class="op">=</span><span class="cn">TRUE</span>,
                                celltypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>,<span class="st">"Immune_marker1,Immune_marker3"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>,
                                             <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span><span class="op">)</span>,
                                feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span>
<span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">data_subset</span>, feature_colname <span class="op">=</span> <span class="st">"Phenotype"</span><span class="op">)</span>
<span class="co">#&gt; [1] "Immune_marker1,Immune_marker2"               </span>
<span class="co">#&gt; [2] "Tumour_marker"                               </span>
<span class="co">#&gt; [3] "Immune_marker1,Immune_marker2,Immune_marker4"</span>
<span class="co">#&gt; [4] "Immune_marker1,Immune_marker3"</span></code></pre></div>
<p>In this vignette we will work with all the original phenotypes present in <code>formatted_image</code>.</p>
</div>
<div class="section level4">
<h4 id="dimensionality-reduction-to-identify-mi-sclassified-cells">Dimensionality reduction to identify mi-sclassified cells<a class="anchor" aria-label="anchor" href="#dimensionality-reduction-to-identify-mi-sclassified-cells"></a>
</h4>
<p>We can also check for specific misclassified cells using dimensionality reduction. SPIAT offers tSNE and UMAPs based on marker intensities to visualize cells. Cells of distinct types should be forming clearly different clusters.</p>
<p>The generated dimensionality reduction plots are interactive, and users can hover over each cell and obtain the cell ID. Users can then remove specific misclassified cells.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image2</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/define_celltypes.html">define_celltypes</a></span><span class="op">(</span><span class="va">predicted_image2</span>, 
                   categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1,Immune_marker2"</span>,
                                  <span class="st">"Immune_marker1,Immune_marker3"</span>, 
                                  <span class="st">"Immune_marker1,Immune_marker2,Immune_marker4"</span><span class="op">)</span>, 
                   category_colname <span class="op">=</span> <span class="st">"Phenotype"</span>,
                   names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>,  <span class="st">"Immune3"</span><span class="op">)</span>,
                   new_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>

<span class="co"># Delete cells with unrealistic marker combinations from the dataset</span>
<span class="va">predicted_image2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_celltypes.html">select_celltypes</a></span><span class="op">(</span><span class="va">predicted_image2</span>, <span class="st">"Undefined"</span>, 
                                     feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>, keep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># TSNE plot</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dimensionality_reduction_plot.html">dimensionality_reduction_plot</a></span><span class="op">(</span><span class="va">predicted_image2</span>, plot_type <span class="op">=</span> <span class="st">"TSNE"</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p>Note that <code>dimensionality_reduction_plot</code> only prints a static version of the UMAP or tSNE plot. If the user wants to interact with this plot, they can pass the result to the <code>ggplotly</code> function from the <code>plotly</code> package. Due to the file size restriction, we only show a screenshot of the interactive tSNE plot.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#plotly::ggplotly(g) # uncomment this code to generate the interactive plot</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"tSNE1.jpg"</span><span class="op">)</span></code></pre></div>
<p><img src="tSNE1.jpg" width="70%"></p>
<p>The plot shows that there are four clear clusters based on marker intensities. This is consistent with the cell definition from the marker combinations from the “Phenotype” column. (The interactive TSNE plot would allow users to hover the cursor on the misclassified cells and see their cell IDs.) In this example, Cell_3302, Cell_4917, Cell_2297, Cell_488, Cell_4362, Cell_4801, Cell_2220, Cell_3431, Cell_533, Cell_4925, Cell_4719, Cell_469, Cell_1929, Cell_310, Cell_2536, Cell_321, and Cell_4195 are obviously misclassified according to this plot.</p>
<p>We can use <code>select_celltypes</code> to delete the misclassified cells.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted_image2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/select_celltypes.html">select_celltypes</a></span><span class="op">(</span><span class="va">predicted_image2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cell_3302"</span>, <span class="st">"Cell_4917"</span>, <span class="st">"Cell_2297"</span>, <span class="st">"Cell_488"</span>, <span class="st">"Cell_4362"</span>, <span class="st">"Cell_4801"</span>, <span class="st">"Cell_2220"</span>, <span class="st">"Cell_3431"</span>, <span class="st">"Cell_533"</span>, <span class="st">"Cell_4925"</span>, <span class="st">"Cell_4719"</span>, <span class="st">"Cell_469"</span>, <span class="st">"Cell_1929"</span>, <span class="st">"Cell_310"</span>, <span class="st">"Cell_2536"</span>, <span class="st">"Cell_321"</span>, <span class="st">"Cell_4195"</span><span class="op">)</span>, feature_colname <span class="op">=</span> <span class="st">"rowname"</span>, keep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then plot the TSNE again (not interactive). This time we see there are fewer mis-classified cells.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TSNE plot</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dimensionality_reduction_plot.html">dimensionality_reduction_plot</a></span><span class="op">(</span><span class="va">predicted_image2</span>, plot_type <span class="op">=</span> <span class="st">"TSNE"</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>

<span class="co"># plotly::ggplotly(g) # uncomment this code to interact with the plot</span></code></pre></div>
<p><img src="tSNE2.jpg" width="70%"></p>
</div>
</div>
<div class="section level3">
<h3 id="visualizing-tissues">Visualizing tissues<a class="anchor" aria-label="anchor" href="#visualizing-tissues"></a>
</h3>
<p>In addition to the marker level tissue plots for QC, SPIAT has other methods for visualizing markers and phenotypes in tissues.</p>
<div class="section level4">
<h4 id="categorical-dot-plot">Categorical dot plot<a class="anchor" aria-label="anchor" href="#categorical-dot-plot"></a>
</h4>
<p>We can see the location of all cell types (or any column in the data) in the tissue with <code>plot_cell_categories</code>. Each dot in the plot corresponds to a cell and cells are coloured by cell type. Any cell types present in the data but not in the cell types of interest will be put in the category “OTHER” and coloured lightgrey.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"darkcyan"</span>, <span class="st">"darkgreen"</span><span class="op">)</span>
  
<span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">formatted_image</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>, <span class="st">"Immune3"</span><span class="op">)</span>, 
                     <span class="va">my_colors</span>, <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-30-1.png" width="60%"></p>
</div>
<div class="section level4">
<h4 id="d-surface-plot">3D surface plot<a class="anchor" aria-label="anchor" href="#d-surface-plot"></a>
</h4>
<p>We can visualize a selected marker in 3D with <code>marker_surface_plot</code>. The image is blurred based on the <code>num_splits</code> parameter.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot.html">marker_surface_plot</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, marker<span class="op">=</span><span class="st">"Immune_marker1"</span><span class="op">)</span></code></pre></div>
<p>Due to the restriction of the file size, we have disabled the interactive plot in this vignette. Here only shows a screen shot. (You can interactively move the plot around to obtain a better view with the same code).</p>
<p><img src="marker_surface1.jpg" width="75%"></p>
</div>
<div class="section level4">
<h4 id="d-stacked-surface-plot">3D stacked surface plot<a class="anchor" aria-label="anchor" href="#d-stacked-surface-plot"></a>
</h4>
<p>To visualize multiple markers in 3D in a single plot we can use <code>marker_surface_plot_stack</code>. This shows normalized intensity level of specified markers and enables the identification of co-occurring and mutually exclusive markers.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/marker_surface_plot_stack.html">marker_surface_plot_stack</a></span><span class="op">(</span><span class="va">formatted_image</span>, num_splits<span class="op">=</span><span class="fl">15</span>, markers<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour_marker"</span>, <span class="st">"Immune_marker1"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="marker_surface2.jpg" width="75%"></p>
<p>The stacked surface plots of the Tumour_marker and Immune_marker1 cells in this example shows how Tumour_marker and Immune_marker1 are mutually exclusive as the peaks and valleys are opposite. Similar to the previous plot, we have disabled the interactive plot in the vignette. (You can interactively move the plot around to obtain a better view with the same code.)</p>
</div>
</div>
<div class="section level3">
<h3 id="basic-analyses">Basic analyses<a class="anchor" aria-label="anchor" href="#basic-analyses"></a>
</h3>
<p>For this part of the tutorial, we will be performing some basic analysis on this image:</p>
<p>Plot the image.</p>
<div class="section level4">
<h4 id="cell-percentages">Cell percentages<a class="anchor" aria-label="anchor" href="#cell-percentages"></a>
</h4>
<p>We can obtain the number and proportion of each cell type with <code>calculate_cell_proportions</code>. We can use <code>reference_celltypes</code> to specify cell types to use as the reference. For example, “Total” will calculate the proportion of each cell type against all cells. We can exclude any cell types that are not of interest e.g. “Undefined” with <code>celltypes_to_exclude</code>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cell_proportions.html">calculate_cell_proportions</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                      reference_celltypes<span class="op">=</span><span class="cn">NULL</span>, 
                                      feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span>,
                                      celltypes_to_exclude <span class="op">=</span> <span class="st">"Others"</span>,
                                      plot.image <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-35-1.png" width="60%"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_cells</span>
<span class="co">#&gt;   Cell_type Number_of_celltype Proportion Percentage Proportion_name</span>
<span class="co">#&gt; 5    Tumour                819 0.41679389  41.679389          /Total</span>
<span class="co">#&gt; 3   Immune3                630 0.32061069  32.061069          /Total</span>
<span class="co">#&gt; 1   Immune1                338 0.17201018  17.201018          /Total</span>
<span class="co">#&gt; 2   Immune2                178 0.09058524   9.058524          /Total</span></code></pre></div>
<p>Alternatively, we can also visualize cell type proportions as barplots using <code>plot_cell_percentages</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_percentages.html">plot_cell_percentages</a></span><span class="op">(</span>cell_proportions <span class="op">=</span> <span class="va">p_cells</span>, 
                      cells_to_exclude <span class="op">=</span> <span class="st">"Tumour"</span>, cellprop_colname<span class="op">=</span><span class="st">"Proportion_name"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-36-1.png" width="60%"><img src="introduction_files/figure-html/unnamed-chunk-36-2.png" width="60%"></p>
</div>
<div class="section level4">
<h4 id="cell-distances">Cell distances<a class="anchor" aria-label="anchor" href="#cell-distances"></a>
</h4>
<div class="section level5">
<h5 id="pairwise-cell-distances">Pairwise cell distances<a class="anchor" aria-label="anchor" href="#pairwise-cell-distances"></a>
</h5>
<p>We can calculate the pairwise distances between two cell types (cell type A and cell type B) with <code>calculate_pairwise_distances_between_cell_types</code>. This function calculates the distances of all cells of type A against all cells of type B.</p>
<p>This function returns a data.frame that contains all the pairwise distances between each cell of cell type A and cell type B.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_pairwise_distances_between_celltypes.html">calculate_pairwise_distances_between_celltypes</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                                    cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune3"</span><span class="op">)</span>,
                                                    feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p>The pairwise distances can be visualized as a violin plot with <code>plot_cell_distances_violin</code>.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_distances_violin.html">plot_cell_distances_violin</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-38-1.png" width="75%"></p>
<p>We can also calculate summary statistics for the distances between each combination of cell types, the mean, median, min, max and standard deviation, with <code>calculate_summary_distances_between_cell_types</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summary_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_between_celltypes.html">calculate_summary_distances_between_celltypes</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span>

<span class="va">summary_distances</span>
<span class="co">#&gt;              Pair      Mean      Min      Max    Median  Std.Dev Reference</span>
<span class="co">#&gt; 1 Immune1/Immune1 1164.7096 10.84056 2729.120 1191.3645 552.0154   Immune1</span>
<span class="co">#&gt; 2 Immune1/Immune3 1034.4960 10.23688 2691.514 1026.4414 442.2515   Immune1</span>
<span class="co">#&gt; 3  Immune1/Tumour 1013.3697 13.59204 2708.343 1004.6579 413.7815   Immune1</span>
<span class="co">#&gt; 4 Immune3/Immune1 1034.4960 10.23688 2691.514 1026.4414 442.2515   Immune3</span>
<span class="co">#&gt; 5 Immune3/Immune3  794.7765 10.17353 2645.302  769.9948 397.8863   Immune3</span>
<span class="co">#&gt; 6  Immune3/Tumour  758.2732 10.02387 2670.861  733.4501 380.7703   Immune3</span>
<span class="co">#&gt; 7  Tumour/Immune1 1013.3697 13.59204 2708.343 1004.6579 413.7815    Tumour</span>
<span class="co">#&gt; 8  Tumour/Immune3  758.2732 10.02387 2670.861  733.4501 380.7703    Tumour</span>
<span class="co">#&gt; 9   Tumour/Tumour  711.2657 10.00348 2556.332  703.9096 380.3293    Tumour</span>
<span class="co">#&gt;    Target</span>
<span class="co">#&gt; 1 Immune1</span>
<span class="co">#&gt; 2 Immune3</span>
<span class="co">#&gt; 3  Tumour</span>
<span class="co">#&gt; 4 Immune1</span>
<span class="co">#&gt; 5 Immune3</span>
<span class="co">#&gt; 6  Tumour</span>
<span class="co">#&gt; 7 Immune1</span>
<span class="co">#&gt; 8 Immune3</span>
<span class="co">#&gt; 9  Tumour</span></code></pre></div>
<p>An example of the interpretation of this result is: ‘average pairwise distance between cells of Immune3 and Immune1 is 1034.4959857’.</p>
<p>These pairwise cell distances can then be visualized as a heatmap with <code>plot_distance_heatmap</code>. This example shows the average pairwise distances between cell types. Note that the pairwise distances are symmetrical (the average distance between cell type A and cell type B is the same as the average distance between cell Type B and cell Type A).</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_distance_heatmap.html">plot_distance_heatmap</a></span><span class="op">(</span><span class="va">summary_distances</span>, metric <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-40-1.png" width="75%"></p>
<p>This plot shows that Tumour cells are interacting most closely with Tumour cells and Immune3 cells.</p>
</div>
<div class="section level5">
<h5 id="minimum-cell-distances">Minimum cell distances<a class="anchor" aria-label="anchor" href="#minimum-cell-distances"></a>
</h5>
<p>We can also calculate the minimum distances between cell types with <code>calculate_minimum_distances_between_cell_types</code>. Unlike the pairwise distance were we calculate the distance between all cell types of interest, here we only identify the distance to the closest cell of type B to each of the reference cells of type A.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_minimum_distances_between_celltypes.html">calculate_minimum_distances_between_celltypes</a></span><span class="op">(</span>
  <span class="va">formatted_image</span>, 
  cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>,<span class="st">"Immune3"</span>, <span class="st">"Others"</span><span class="op">)</span>,
  feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="co">#&gt; [1] "Markers had been selected in minimum distance calculation: "</span>
<span class="co">#&gt; [1] "Others"  "Immune1" "Tumour"  "Immune3" "Immune2"</span></code></pre></div>
<p>The minimum distances can be visualized as a violin plot with <code>plot_cell_distances_violin</code>. Visualization of this distribution often reveals whether pairs of cells are evenly spaced across the image, or whether there are clusters of pairs of cell types.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_distances_violin.html">plot_cell_distances_violin</a></span><span class="op">(</span><span class="va">min_dist</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-42-1.png" width="75%"></p>
<p>We can also calculate summary statistics for the distances between each combination of cell types, the mean, median, min, max and standard deviation, with <code>calculate_summary_distances_between_cell_types</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_summary_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_between_celltypes.html">calculate_summary_distances_between_celltypes</a></span><span class="op">(</span><span class="va">min_dist</span><span class="op">)</span>

<span class="co"># show the first five rows</span>
<span class="va">min_summary_dist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,<span class="op">]</span>
<span class="co">#&gt;              Pair     Mean      Min       Max   Median  Std.Dev Reference</span>
<span class="co">#&gt; 1 Immune1/Immune2 63.65211 10.33652 158.80504 59.01846 32.58482   Immune1</span>
<span class="co">#&gt; 2 Immune1/Immune3 88.46152 10.23688 256.30328 77.21765 53.73164   Immune1</span>
<span class="co">#&gt; 3  Immune1/Others 19.24038 10.05203  49.86409 17.49196  7.19293   Immune1</span>
<span class="co">#&gt; 4  Immune1/Tumour 85.84773 13.59204 223.15809 80.80592 40.72454   Immune1</span>
<span class="co">#&gt; 5 Immune2/Immune1 48.45885 10.33652 132.31086 43.71936 27.43245   Immune2</span>
<span class="co">#&gt;    Target</span>
<span class="co">#&gt; 1 Immune2</span>
<span class="co">#&gt; 2 Immune3</span>
<span class="co">#&gt; 3  Others</span>
<span class="co">#&gt; 4  Tumour</span>
<span class="co">#&gt; 5 Immune1</span></code></pre></div>
<p>Unlike the pairwise distance, the minimum distances are not symmetrical, and therefore we output a summary of the minimum distances specifying the reference and target cell types used.</p>
<p>An example of the interpretation of this result is: ‘average minimum distance between cells of Immune1 and Tumour is 85.8477321’.</p>
<p>Similarly, the summary statistics of the minimum distances can also be visualised by a heatmap. This example shows the average minimum distance between cell types.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_distance_heatmap.html">plot_distance_heatmap</a></span><span class="op">(</span><span class="va">min_summary_dist</span>, metric <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-44-1.png" width="75%"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="cell-colocalization">Cell colocalization<a class="anchor" aria-label="anchor" href="#cell-colocalization"></a>
</h3>
<p>With SPIAT we can quantify cell colozalization, which refers to how much two cell types are colocalizing and thus potentially interacting.</p>
<div class="section level4">
<h4 id="cells-in-neighbourhood-cin">Cells In Neighbourhood (CIN)<a class="anchor" aria-label="anchor" href="#cells-in-neighbourhood-cin"></a>
</h4>
<p>We can calculate the average percentage of cells of one cell type (target) within a radius of another cell type (reference) using <code>average_percentage_of_cells_within_radius</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_percentage_of_cells_within_radius.html">average_percentage_of_cells_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                          reference_celltype <span class="op">=</span> <span class="st">"Immune1"</span>, 
                                          target_celltype <span class="op">=</span> <span class="st">"Immune2"</span>, 
                                          radius<span class="op">=</span><span class="fl">100</span>, feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="co">#&gt; [1] 4.768123</span></code></pre></div>
<p>Alternatively, this analysis can also be performed based on marker intensities rather than cell types. Here, we use <code>average_marker_intensity_within_radius</code> to calculate the average intensity of the target_marker within a radius from the cells positive for the reference marker. Note that it pools all cells with the target marker that are within the specific radius of any reference cell. Results represent the average intensities within a radius.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_marker_intensity_within_radius.html">average_marker_intensity_within_radius</a></span><span class="op">(</span><span class="va">formatted_image</span>,
                                        reference_marker <span class="op">=</span><span class="st">"Immune_marker3"</span>,
                                        target_marker <span class="op">=</span> <span class="st">"Immune_marker2"</span>,
                                        radius<span class="op">=</span><span class="fl">30</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.5995357</span></code></pre></div>
<p>To help identify suitable radii for <code>average_percentage_of_cells_within_radius</code> and <code>average_marker_intensity_within_radius</code> users can use <code>plot_average_intensity</code>. This function calculates the average intensity of a target marker for a number of user-supplied radii values, and plots the intensity level at each specified radius as a line graph. The radius unit is pixels.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_average_intensity.html">plot_average_intensity</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_marker<span class="op">=</span><span class="st">"Immune_marker3"</span>, 
                       target_marker<span class="op">=</span><span class="st">"Immune_marker2"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">35</span>, <span class="fl">40</span>, <span class="fl">45</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-47-1.png" width="60%"></p>
<p>This plot shows low levels of Immune_marker3 were observed in cells near Immune_marker2 cells and these levels increased at larger radii. This suggests Immune_marker2 and Immune_marker3 cells may not be closely interacting and are actually repelled.</p>
</div>
<div class="section level4">
<h4 id="mixing-score-ms-and-normalized-mixing-score-nms">Mixing Score (MS) and Normalized Mixing Score (NMS)<a class="anchor" aria-label="anchor" href="#mixing-score-ms-and-normalized-mixing-score-nms"></a>
</h4>
<p>This score was originally defined as the number of immune-tumor interactions divided by the number of immune-immune interactions <span class="citation">(Keren et al. 2018)</span>. SPIAT generalizes this method for any user-defined pair of cell types. <code>mixing_score_summary</code> returns the mixing score between a reference cell type and a target cell type. This mixing score is defined as the number of target-reference interactions/number of reference-reference interactions within a specified radius. The higher the score the greater the mixing of the two cell types. The normalized score is normalized for the number of target and reference cells in the image.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mixing_score_summary.html">mixing_score_summary</a></span><span class="op">(</span><span class="va">formatted_image</span>, reference_celltype <span class="op">=</span> <span class="st">"Immune1"</span>, 
                     target_celltype <span class="op">=</span> <span class="st">"Immune2"</span>, radius<span class="op">=</span><span class="fl">100</span>, feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="co">#&gt;   Reference  Target Number_of_reference_cells Number_of_target_cells</span>
<span class="co">#&gt; 2   Immune1 Immune2                       338                    178</span>
<span class="co">#&gt;   Reference_target_interaction Reference_reference_interaction Mixing_score</span>
<span class="co">#&gt; 2                          583                            1184    0.4923986</span>
<span class="co">#&gt;   Normalised_mixing_score</span>
<span class="co">#&gt; 2                1.864476</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="cross-k-function">Cross K function<a class="anchor" aria-label="anchor" href="#cross-k-function"></a>
</h4>
<p>Cross K function calculates the number of target cell types across a range of raddi from a reference cell type, and compares the behaviour of the input image with an image of randomly distributed points using a Poisson point process. There are four patterns that can be distinguished from K-cross function, as illustrated in the plots below. (taken from <a href="https://blog.jlevente.com/understanding-the-cross-k-function/" class="external-link">here</a> in April 2021).</p>
<p><img src="cross-k-function.jpg" width="100%"></p>
<p>Here, the black line represents the input image, the red line represents a randomly distributed point pattern.</p>
<ul>
<li>1st plot: The red line and black line are close to each other, meaning the two types of points are randomly independently distributed.<br>
</li>
<li>2nd plot: The red line is under the black line, with a large difference in the middle of the plot, meaning the points are mixed and split into clusters.<br>
</li>
<li>3rd plot: With the increase of radius, the black line diverges further from the red line, meaning that there is one mixed cluster of two types of points.<br>
</li>
<li>4th plot: The red line is above the black line, meaning that the two types of points form separated clusters.</li>
</ul>
<p>We can calculate the cross K-function using SPIAT. Here, we need to define which are the cell types of interest. In this example, we are using Tumour cells as the reference population, and Immune3 cells as the target population.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_cross</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cross_functions.html">calculate_cross_functions</a></span><span class="op">(</span><span class="va">formatted_image</span>, method <span class="op">=</span> <span class="st">"Kcross"</span>, 
                                      cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune2"</span><span class="op">)</span>, 
                                      feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span>,
                                      dist <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-50-1.png" width="60%"> The results shows similar pattern as the 4th plot in the cross K diagram. This means “Tumour” cells and “Immune2” cells are not colocalised (or form separate clusters).</p>
<p>We can calculate the area under the curve (AUC) of the cross K-function. In general, this tells us the two types of cells are:</p>
<ul>
<li>negative values: separate clusters</li>
<li>positive values: mixing of cell types</li>
</ul>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/AUC_of_cross_function.html">AUC_of_cross_function</a></span><span class="op">(</span><span class="va">df_cross</span><span class="op">)</span>
<span class="co">#&gt; [1] -0.2836735</span></code></pre></div>
<p>The AUC score is close to zero so this tells us that the two types of cells either do not have a relationship or they form a ring surrounding a cluster.</p>
</div>
<div class="section level4">
<h4 id="cross-k-intersection-cki">Cross-K Intersection (CKI)<a class="anchor" aria-label="anchor" href="#cross-k-intersection-cki"></a>
</h4>
<p>There is another pattern in cross K curve which has not been previously appreciated, which is when there is a “ring” of one cell type, generally immune cells, surrounding the area of another cell type, generally tumour cells. For this pattern, the observed and expected curves in cross K function cross or intersect, such as the cross K plot above.</p>
<p>We note that crossing is not exclusively present in cases where there is an immune ring. When separate clusters of two cell types are close, there can be a crossing at a small radius. In images with infiltration, crossing may also happen at an extremely low distances due to randomness. To use the CKI to detect a ring pattern, users need to determine a threshold for when there is a true a immune ring. Based on our tests, these are generally fall within at a quarter to half of the image size, but users are encouraged to experiment with their dataset.</p>
<p>Here we use the colocalisation of “Tumour” and “Immune3” cells as an example. Let’s revisit the example image.</p>
<p><img src="introduction_files/figure-html/unnamed-chunk-52-1.png" width="60%"></p>
<p>Compute the cross K function between “Tumour” and “Immune3”:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_cross</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_cross_functions.html">calculate_cross_functions</a></span><span class="op">(</span><span class="va">formatted_image</span>, method <span class="op">=</span> <span class="st">"Kcross"</span>, 
                                      cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune3"</span><span class="op">)</span>, 
                                      feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span>,
                                      dist <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-53-1.png" width="60%"></p>
<p>Then find the intersection of the observed and expected cross K curves.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/crossing_of_crossK.html">crossing_of_crossK</a></span><span class="op">(</span><span class="va">df_cross</span><span class="op">)</span>
<span class="co">#&gt; [1] "Crossing of cross K function is detected for this image, indicating a potential immune ring."</span>
<span class="co">#&gt; [1] "The crossing happens at the 50 % of the specified distance."</span>
<span class="co">#&gt; [1] 0.5</span></code></pre></div>
<p>The result shows that the crossing happens at 50% of the specified distance (100) of the cross K function, which is very close to the edge of the tumour cluster. This means that the crossing is not due to the randomness in cell distribution, nor due to two close located immune and tumour clusters. This result aligns with the observation that there is an immune ring surrounding the tumour cluster.</p>
</div>
</div>
<div class="section level3">
<h3 id="spatial-heterogeneity">Spatial heterogeneity<a class="anchor" aria-label="anchor" href="#spatial-heterogeneity"></a>
</h3>
<p>Cell colocalization metrics allow capturing a dominant spatial pattern in an image. However, patterns are unlikely to be distributed evenly in an tissue, but rather there will be spatial heterogeneity of patterns. To measure this, SPIAT splits the image into smaller images (either using a grid or concentric circles around a reference cell population), followed by calculation of a spatial metric of a pattern of interest (e.g. cell colocalization, entropy), and then measures the Prevalance and Distinctiveness of the pattern.</p>
<div class="section level4">
<h4 id="localized-entropy">Localized Entropy<a class="anchor" aria-label="anchor" href="#localized-entropy"></a>
</h4>
<p>Entropy in spatial analysis refers to the balance in the number of cells of distinct populations. An entropy score can be obtained for an entire image. However, the entropy of one image does not provide us spatial information of the image.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_entropy.html">calculate_entropy</a></span><span class="op">(</span><span class="va">formatted_image</span>, cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune1"</span>,<span class="st">"Immune2"</span><span class="op">)</span>, 
                  feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.9294873</span></code></pre></div>
<p>We therefore propose the concept of Localised Entropy, which calculates an entropy score for a predefined local region. These local regions can be calculated as defined in the next two sections.</p>
</div>
<div class="section level4">
<h4 id="fish-net-grid">Fish net grid<a class="anchor" aria-label="anchor" href="#fish-net-grid"></a>
</h4>
<p>One approach to calculate localised metric is to split the image into “fish-net” grid squares. For each grid square, <code>grid_metrics</code> calculate the metric for that square and visualise the raster image. Users can choose any metric as the localised metric. Here we use entropy as an example.</p>
<p>For cases where the localised metric is not symmetrical (requires specifying a target and reference cell type), the first iten in the vector used for <code>cell_types_of_interest</code> marks the reference cells and the second item the target cells. Here we are using Entropy, which is not symmetrical, so we can use any order of cell types in the input.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"defined_image"</span><span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_metrics.html">grid_metrics</a></span><span class="op">(</span><span class="va">defined_image</span>, FUN <span class="op">=</span> <span class="va">calculate_entropy</span>, n_split <span class="op">=</span> <span class="fl">20</span>,
                     cell_types_of_interest<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>,<span class="st">"Immune3"</span><span class="op">)</span>, 
                     feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-56-1.png" width="70%"></p>
<p>After calculating the localised entropy for each of the grid squares, we can apply metrics like percentages of grid squares with patterns (Prevalence) and Moran’s I (Distinctiveness).</p>
<p>For the Prevalence, we need to select a threshold over which grid squares are considered ‘positive’ for the pattern. The selection of threshold depends on the pattern and metric the user chooses to find the localised pattern. Here we chose 0.75 for entropy because 0.75 is roughly the entropy of two cell types when their ratio is 1:5 or 5:1.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_percentage_of_grids.html">calculate_percentage_of_grids</a></span><span class="op">(</span><span class="va">grid</span>, threshold <span class="op">=</span> <span class="fl">0.75</span>, above <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; [1] 13</span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/calculate_spatial_autocorrelation.html">calculate_spatial_autocorrelation</a></span><span class="op">(</span><span class="va">grid</span>, metric <span class="op">=</span> <span class="st">"globalmoran"</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.09446964</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gradients-based-on-concentric-circles">Gradients (based on concentric circles)<a class="anchor" aria-label="anchor" href="#gradients-based-on-concentric-circles"></a>
</h4>
<p>We can use the <code>gradient</code> function to calculate metrics (entropy, mixing score, percentage of cells within radius, marker intensity) for a range of radii from reference cells. Here, an increasing circle is drawn around each cell of the reference cell type and the desired score is calculated for cells within each circle.</p>
<p>The first iten in the vector used for <code>cell_types_of_interest</code> marks the reference cells and the second item the target cells. Here, Immune1 cells are reference cells and Immune2 are target cells.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gradient_positions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>
<span class="va">gradient_entropy</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/compute_gradient.html">compute_gradient</a></span><span class="op">(</span><span class="va">defined_image</span>, radii <span class="op">=</span> <span class="va">gradient_positions</span>, 
                   FUN <span class="op">=</span> <span class="va">calculate_entropy</span>,  cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune1"</span>,<span class="st">"Immune2"</span><span class="op">)</span>,
                   feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gradient_entropy</span><span class="op">)</span>
<span class="co">#&gt; [1] 3</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gradient_entropy</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;         Cell.X.Position Cell.Y.Position Immune1 Immune2 total Immune1_log2</span>
<span class="co">#&gt; Cell_15       109.67027        17.12956       1       0     1            0</span>
<span class="co">#&gt; Cell_25       153.22795       128.29915       1       0     1            0</span>
<span class="co">#&gt; Cell_30        57.29037        49.88533       1       0     1            0</span>
<span class="co">#&gt; Cell_48        83.47798       295.75058       2       0     2            1</span>
<span class="co">#&gt; Cell_56        35.24227       242.84862       1       0     1            0</span>
<span class="co">#&gt; Cell_61       156.39943       349.08154       2       0     2            1</span>
<span class="co">#&gt;         Immune2_log2 total_log2 Immune1ratio Immune1_entropy Immune2ratio</span>
<span class="co">#&gt; Cell_15            0          0            1               0            0</span>
<span class="co">#&gt; Cell_25            0          0            1               0            0</span>
<span class="co">#&gt; Cell_30            0          0            1               0            0</span>
<span class="co">#&gt; Cell_48            0          1            1               0            0</span>
<span class="co">#&gt; Cell_56            0          0            1               0            0</span>
<span class="co">#&gt; Cell_61            0          1            1               0            0</span>
<span class="co">#&gt;         Immune2_entropy entropy</span>
<span class="co">#&gt; Cell_15               0       0</span>
<span class="co">#&gt; Cell_25               0       0</span>
<span class="co">#&gt; Cell_30               0       0</span>
<span class="co">#&gt; Cell_48               0       0</span>
<span class="co">#&gt; Cell_56               0       0</span>
<span class="co">#&gt; Cell_61               0       0</span></code></pre></div>
<p>The <code>compute_gradient</code> function outputs the numbers cells within each radii for each reference cell. The output is formatted as a list of data.frames, one for each specified radii. In each data.frame, the rows show the reference cells. The last column of the data.frame is the entropy calculated for cells in the circle of the reference cell. Users can then an average score or another aggregation metric to report the results.</p>
<p>An alternative approach is to combine the results of all the circles (rather than have one for each individual reference cell). Here, for each radii, we simultaneously identify all the cells in the circles surrounding each reference cell, and calculate a single entropy score. We have created a specific function for this - <code>entropy_gradient_aggregated</code>. The output of this function is an overall entropy score for each radii.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gradient_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">500</span>, <span class="fl">50</span><span class="op">)</span> <span class="co">##radii</span>
<span class="va">gradient_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/entropy_gradient_aggregated.html">entropy_gradient_aggregated</a></span><span class="op">(</span><span class="va">defined_image</span>, cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune3"</span>,<span class="st">"Tumour"</span><span class="op">)</span>,
                                                feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>, radii <span class="op">=</span> <span class="va">gradient_pos</span><span class="op">)</span>
<span class="co"># plot the results</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="va">gradient_results</span><span class="op">$</span><span class="va">gradient_df</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-60-1.png" width="60%"></p>
</div>
</div>
<div class="section level3">
<h3 id="characterizing-the-immune-microenvironment-relative-to-the-tumour-margin">Characterizing the immune microenvironment relative to the tumour margin<a class="anchor" aria-label="anchor" href="#characterizing-the-immune-microenvironment-relative-to-the-tumour-margin"></a>
</h3>
<p>In certain analysis the focus is understanding the spatial distribution of immune populations relative to the tumor margin. SPIAT includes methods to determine whether there is a clear tumor margin, to automatically identify the tumor margin, and finally to quantify the proportion of immune populations relative to the margin.</p>
<div class="section level4">
<h4 id="determining-whether-there-is-a-clear-tumor-margin">Determining whether there is a clear tumor margin<a class="anchor" aria-label="anchor" href="#determining-whether-there-is-a-clear-tumor-margin"></a>
</h4>
<p>In some instances tumor cells are distributed in such a way that there are no clear tumor margins. While this can be derived intuitively in most cases, SPIAT offers a way of quantifying the ‘quality’ of the margin for downstream analyses. This is meant to be used to help flag images with relatively poor margins, and therefore we do not offer a cutoff value.</p>
<p>To determine if there is a clear tumour margin, SPIAT can calculate the ratio of tumour bordering cells to tumour total cells (R-BT). This ratio is high when there is a disproportional high number of tumor mangin cells compared to internal tumor cells.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/R_BT.html">R_BT</a></span><span class="op">(</span><span class="va">formatted_image</span>, cell_type_of_interest <span class="op">=</span> <span class="st">"Tumour"</span>, <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-61-1.png" width="60%"></p>
<pre><code><span class="co">#&gt; [1] 0.2014652</span></code></pre>
<p>The result is 0.2014652. This low value means there are relatively low number of bordering cells compared to total tumor cells, meaning that this image has clear tumor margins.</p>
</div>
<div class="section level4">
<h4 id="automatic-identification-of-the-tumor-margin">Automatic identification of the tumor margin<a class="anchor" aria-label="anchor" href="#automatic-identification-of-the-tumor-margin"></a>
</h4>
<p>We can identify margins with <code>identify_bordering_cells</code>. This function leverages off the alpha hull method <span class="citation">(Pateiro-Lopez, Rodriguez-Casal, and. 2019)</span> from the alphahull package. Here we use tumour cells (Tumour_marker) as the reference to identify the bordering cells but any cell type can be used.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_border</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_bordering_cells.html">identify_bordering_cells</a></span><span class="op">(</span><span class="va">formatted_image</span>, 
                                             reference_cell <span class="op">=</span> <span class="st">"Tumour"</span>, 
                                             feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="co">#&gt; [1] "The alpha of Polygon is: 63.24375"</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-62-1.png" width="60%"></p>
</div>
<div class="section level4">
<h4 id="classification-of-cells-relative-to-their-location-to-the-margin">Classification of cells relative to their location to the margin<a class="anchor" aria-label="anchor" href="#classification-of-cells-relative-to-their-location-to-the-margin"></a>
</h4>
<p>We can then define four locations relative to the margin based on distances: “Internal margin”, “External margin”, “Outside” and “Inside”. Specifically, we define the area within a specified distance to the margin as either “Internal margin” (bordering the margin, inside the tumor area) and “External margin” (bordering the margin, surrounding the tumor area). The areas located further away than the specified distance from the margin are defined as “Inside” (i.e. the tumor area) and “Outside” (i.e. the tumor area).</p>
<p><img src="tumour-structure.jpg" width="75%"></p>
<p>First, we calculate the distance of cells to the tumor margin.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formatted_distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_distance_to_tumour_margin.html">calculate_distance_to_tumour_margin</a></span><span class="op">(</span><span class="va">formatted_border</span><span class="op">)</span>
<span class="co">#&gt; [1] "Markers had been selected in minimum distance calculation: "</span>
<span class="co">#&gt; [1] "Non-border" "Border"</span></code></pre></div>
<p>Next, we classify cells based on their location. As a distance cutoff, we use a distance of 5 cells from the tumor margin. The function first calculates the average minimum distance between all pairs of nearest cells and then multiples this number by 5. Users can change the number of cell layers to increase/decrease the margin width.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">names_of_immune_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune1"</span>, <span class="st">"Immune2"</span>,<span class="st">"Immune3"</span><span class="op">)</span>

<span class="va">formatted_structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_structure.html">define_structure</a></span><span class="op">(</span><span class="va">formatted_distance</span>, 
                                        names_of_immune_cells <span class="op">=</span> <span class="va">names_of_immune_cells</span>, 
                                        feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span>,
                                        n_margin_layers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="va">categories</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/print_feature.html">print_feature</a></span><span class="op">(</span><span class="va">formatted_structure</span>, <span class="st">"Structure"</span><span class="op">)</span>
<span class="co">#&gt; [1] "Outside"                "Stromal.immune"         "Internal.margin"       </span>
<span class="co">#&gt; [4] "Border"                 "External.margin.immune" "Internal.margin.immune"</span>
<span class="co">#&gt; [7] "External.margin"        "Inside"                 "Infiltrated.immune"</span></code></pre></div>
<p>We can plot and colour these structure categories.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">formatted_structure</span>, feature_colname <span class="op">=</span> <span class="st">"Structure"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-66-1.png" width="90%"></p>
<p>We can also calculate the proportion of immune cells in each of the locations.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immune_proportions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_proportions_of_cells_in_structure.html">calculate_proportions_of_cells_in_structure</a></span><span class="op">(</span><span class="va">formatted_structure</span>, cell_types_of_interest <span class="op">=</span> <span class="va">names_of_immune_cells</span>, feature_colname <span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span>

<span class="va">immune_proportions</span>
<span class="co">#&gt;                Cell.Type                            Relative_to</span>
<span class="co">#&gt; 1                Immune1             All_cells_in_the_structure</span>
<span class="co">#&gt; 2                Immune2             All_cells_in_the_structure</span>
<span class="co">#&gt; 3                Immune3             All_cells_in_the_structure</span>
<span class="co">#&gt; 4                Immune1 All_cells_of_interest_in_the_structure</span>
<span class="co">#&gt; 5                Immune2 All_cells_of_interest_in_the_structure</span>
<span class="co">#&gt; 6                Immune3 All_cells_of_interest_in_the_structure</span>
<span class="co">#&gt; 7                Immune1  The_same_cell_type_in_the_whole_image</span>
<span class="co">#&gt; 8                Immune2  The_same_cell_type_in_the_whole_image</span>
<span class="co">#&gt; 9                Immune3  The_same_cell_type_in_the_whole_image</span>
<span class="co">#&gt; 10 All_cells_of_interest             All_cells_in_the_structure</span>
<span class="co">#&gt;    P.Infiltrated.Immune P.Internal.Margin.Immune P.External.Margin.Immune</span>
<span class="co">#&gt; 1            0.00000000               0.00000000              0.005494505</span>
<span class="co">#&gt; 2            0.00000000               0.00000000              0.005494505</span>
<span class="co">#&gt; 3            0.14385965               0.08780488              2.159340659</span>
<span class="co">#&gt; 4            0.00000000               0.00000000              0.002531646</span>
<span class="co">#&gt; 5            0.00000000               0.00000000              0.002531646</span>
<span class="co">#&gt; 6            1.00000000               1.00000000              0.994936709</span>
<span class="co">#&gt; 7            0.00000000               0.00000000              0.002958580</span>
<span class="co">#&gt; 8            0.00000000               0.00000000              0.005617978</span>
<span class="co">#&gt; 9            0.06507937               0.05714286              0.623809524</span>
<span class="co">#&gt; 10           0.14385965               0.08780488              2.170329670</span>
<span class="co">#&gt;    P.Stromal.Immune</span>
<span class="co">#&gt; 1        0.11971581</span>
<span class="co">#&gt; 2        0.06287744</span>
<span class="co">#&gt; 3        0.05683837</span>
<span class="co">#&gt; 4        0.50000000</span>
<span class="co">#&gt; 5        0.26261128</span>
<span class="co">#&gt; 6        0.23738872</span>
<span class="co">#&gt; 7        0.99704142</span>
<span class="co">#&gt; 8        0.99438202</span>
<span class="co">#&gt; 9        0.25396825</span>
<span class="co">#&gt; 10       0.23943162</span></code></pre></div>
<p>Finally, we can calculate summaries of the distances for immune cells in the tumour structure.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">immune_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_summary_distances_of_cells_to_borders.html">calculate_summary_distances_of_cells_to_borders</a></span><span class="op">(</span><span class="va">formatted_structure</span>, cell_types_of_interest <span class="op">=</span> <span class="va">names_of_immune_cells</span>, <span class="st">"Cell.Type"</span><span class="op">)</span>

<span class="va">immune_distances</span>
<span class="co">#&gt;                    Cell.Type       Area    Min_d    Max_d    Mean_d  Median_d</span>
<span class="co">#&gt; 1 All_cell_types_of_interest Tumor_area 10.93225 192.4094  86.20042  88.23299</span>
<span class="co">#&gt; 2 All_cell_types_of_interest     Stroma 10.02387 984.0509 218.11106 133.18220</span>
<span class="co">#&gt; 3                    Immune1 Tumor_area       NA       NA        NA        NA</span>
<span class="co">#&gt; 4                    Immune1     Stroma 84.20018 970.7749 346.14096 301.01535</span>
<span class="co">#&gt; 5                    Immune2 Tumor_area       NA       NA        NA        NA</span>
<span class="co">#&gt; 6                    Immune2     Stroma 79.42753 984.0509 333.26374 284.09062</span>
<span class="co">#&gt; 7                    Immune3 Tumor_area 10.93225 192.4094  86.20042  88.23299</span>
<span class="co">#&gt; 8                    Immune3     Stroma 10.02387 971.5638 102.79227  68.19218</span>
<span class="co">#&gt;    St.dev_d</span>
<span class="co">#&gt; 1  45.27414</span>
<span class="co">#&gt; 2 199.87586</span>
<span class="co">#&gt; 3        NA</span>
<span class="co">#&gt; 4 187.04247</span>
<span class="co">#&gt; 5        NA</span>
<span class="co">#&gt; 6 185.67518</span>
<span class="co">#&gt; 7  45.27414</span>
<span class="co">#&gt; 8 131.32714</span></code></pre></div>
<p>Note that for cell types that are not present in a tumour structure, there should be NAs in the results.</p>
</div>
</div>
<div class="section level3">
<h3 id="cellular-neighbourhoods">Cellular neighbourhoods<a class="anchor" aria-label="anchor" href="#cellular-neighbourhoods"></a>
</h3>
<p>The aggregation of cells can result in ‘cellular neighbourhoods’. A neighbourhood is defined as a group of cells that cluster together. These can be homotypic, containing cells of a single class (e.g. immune cells), or heterotypic (e.g. containing a mixture of tumour and immune cells).</p>
<p>SPIAT can identify cellular neighbourhoods with <code>identify_neighborhoods</code>. Users can select a subset of cell types of interest if desired. SPIAT include three algorithms for the detection of neighbourhoods.</p>
<ul>
<li>
<em>Hierarchical Clustering algorithm</em>: Euclidean distances between cells are calculated, and pairs of cells with a distance less than a specified radius are considered to be ‘interacting’, with the rest being ‘non-interacting’. Hierarchical clustering is then used to separate the clusters. Larger radii will result in the merging of individual clusters.</li>
<li><em>dbscan</em></li>
<li><em>phenograph</em></li>
</ul>
<p>For <em>Hierarchical Clustering algorithm</em> and <em>dbscan</em>, users need to specify a radius that defines the distance for an interaction. We suggest users to test different radii and select the one that generates intuitive clusters upon visualization. Cells not assigned to clusters are assigned to Cluster_NA in the output table. The argument <code>min_neighborhood_size</code> specifies the threshold of a neighborhood size to be considered as a neighborhood. Smaller neighbourhoods will be outputted, but will not be assigned a number.</p>
<p><em>Rphenograph</em> uses the number of nearest neighbours to detect clusters. This number should be specified by <code>min_neighborhood_size</code> argument. We also encourage users to test different values.</p>
<p>For this part of the tutorial, we will use the image <code>image_no_markers</code> simulated with the <code>spaSim</code> package. This image contains “Tumor”, “Immune”, “Immune1” and “Immune2” cells without marker intensities.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_no_markers"</span><span class="op">)</span>

<span class="fu"><a href="../reference/plot_cell_categories.html">plot_cell_categories</a></span><span class="op">(</span><span class="va">image_no_markers</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Tumour"</span>, <span class="st">"Immune"</span>,<span class="st">"Immune1"</span>,<span class="st">"Immune2"</span>,<span class="st">"Others"</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"blue"</span>,<span class="st">"darkgreen"</span>, <span class="st">"brown"</span>,<span class="st">"lightgray"</span><span class="op">)</span>,<span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-69-1.png" width="75%"></p>
<p>Users are recommended to test out different radii and then visualize the clustering results. To aid in this process, users can use the <code>average_minimum_distance</code> function, which calculates the average minimum distance between all cells in an image, and can be used as a starting point.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_minimum_distance.html">average_minimum_distance</a></span><span class="op">(</span><span class="va">image_no_markers</span><span class="op">)</span>
<span class="co">#&gt; [1] 17.01336</span></code></pre></div>
<p>We then identify the cellular neighbourhoods using our heirarchical algorithm with a radius of 50, and with a minimum neighbourhood size of 100. Cells assigned to neighbourhoods smaller than 100 will be assigned to the “Cluster_NA” neighbourhood.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identify_neighborhoods.html">identify_neighborhoods</a></span><span class="op">(</span><span class="va">image_no_markers</span>, 
                                   method <span class="op">=</span> <span class="st">"hierarchical"</span>,
                                   min_neighborhood_size <span class="op">=</span> <span class="fl">100</span>,
                                   cell_types_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune"</span>, <span class="st">"Immune1"</span>, <span class="st">"Immune2"</span><span class="op">)</span>, 
                                   radius <span class="op">=</span> <span class="fl">50</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-71-1.png" width="60%"></p>
<p>This plot shows clusters of Immune, Immune1 and Immune2 cells. Each number and colour corresponds to a distinct cluster. Black cells correspond to ‘free’, un-clustered cells.</p>
<p>We can visualize the cell composition of neighborhoods. To do this, we can use <code>composition_of_neighborhoods</code> to obtain the percentages of cells with a specific marker within each neighborhood and the number of cells in the neighborhood.</p>
<p>In this example we select cellular neighbourhoods with at least 5 cells.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neighorhoods_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/composition_of_neighborhoods.html">composition_of_neighborhoods</a></span><span class="op">(</span><span class="va">clusters</span>, feature_colname <span class="op">=</span> <span class="st">"Cell.Type"</span><span class="op">)</span>
<span class="va">neighorhoods_vis</span> <span class="op">&lt;-</span> <span class="va">neighorhoods_vis</span><span class="op">[</span><span class="va">neighorhoods_vis</span><span class="op">$</span><span class="va">Total_number_of_cells</span> <span class="op">&gt;=</span><span class="fl">5</span>,<span class="op">]</span></code></pre></div>
<p>Finally, we can use <code>plot_composition_heatmap</code> to produce a heatmap showing the marker percentages within each cluster, which can be used to classify the derived neighbourhoods.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_composition_heatmap.html">plot_composition_heatmap</a></span><span class="op">(</span><span class="va">neighorhoods_vis</span>, feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span><span class="op">)</span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-73-1.png" width="70%"></p>
<p>This plot shows that Cluster_1 and Cluster_2 contain all three types of immune cells. Cluster_3 does not have Immune1 cells. Cluster_1 and Cluster_2 are more similar to the free cells (cells not assigned to clusters) in their composition than Cluster_3.</p>
<div class="section level4">
<h4 id="average-nearest-neighbour-index-anni">Average Nearest Neighbour Index (ANNI)<a class="anchor" aria-label="anchor" href="#average-nearest-neighbour-index-anni"></a>
</h4>
<p>We can test for the presence of neighbourhoods using ANNI. We can calculate the ANNI with the function <code>average_nearest_neighbor_index</code>, which can take one cell type of interest (e.g. <code>Cluster_1</code> under <code>Neighborhood</code> column of <code>clusters</code> object) or a combinations of cell types (e.g. <code>Immune1</code> and <code>Immune2</code> cells under <code>Cell.Type</code> column of <code>image_no_markers</code> object) and will output whether there is a clear neighbourhood (clustered) or unclear (dispersed/random), along with a P value for the estimate.</p>
<p>Here show the examples for both one cell type and multiple cell types.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_nearest_neighbor_index.html">average_nearest_neighbor_index</a></span><span class="op">(</span><span class="va">clusters</span>, reference_celltypes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cluster_1"</span><span class="op">)</span>, 
                               feature_colname<span class="op">=</span><span class="st">"Neighborhood"</span>, p_val <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>
<span class="co">#&gt; $pattern</span>
<span class="co">#&gt; [1] "Clustered"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`p-value`</span>
<span class="co">#&gt; [1] 4.616213e-110</span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/average_nearest_neighbor_index.html">average_nearest_neighbor_index</a></span><span class="op">(</span><span class="va">image_no_markers</span>, reference_celltypes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune"</span>, <span class="st">"Immune1"</span> , <span class="st">"Immune2"</span><span class="op">)</span>, 
                               feature_colname<span class="op">=</span><span class="st">"Cell.Type"</span>, p_val <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>
<span class="co">#&gt; $pattern</span>
<span class="co">#&gt; [1] "Random"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`p-value`</span>
<span class="co">#&gt; [1] 0.4000806</span></code></pre></div>
<p><code>p_val</code> is the cutoff to determine if a pattern is significant or not. If the p value of ANNI is larger than the threshold, the pattern will be “Random”. Although we give a default p value cutoff of 5e-6, we suggest the users to define their own cutoff based on the images and how they define the patterns “Cluster” and “Dispersed”.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="reproducibility">Reproducibility<a class="anchor" aria-label="anchor" href="#reproducibility"></a>
</h2>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.2.0 (2022-04-22)</span>
<span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span>
<span class="co">#&gt; Running under: Ubuntu 20.04.4 LTS</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0</span>
<span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span>
<span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span>
<span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span>
<span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span>
<span class="co">#&gt; [8] base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] SPIAT_0.99.0                SingleCellExperiment_1.18.0</span>
<span class="co">#&gt;  [3] SummarizedExperiment_1.26.1 Biobase_2.56.0             </span>
<span class="co">#&gt;  [5] GenomicRanges_1.48.0        GenomeInfoDb_1.32.2        </span>
<span class="co">#&gt;  [7] IRanges_2.30.0              S4Vectors_0.34.0           </span>
<span class="co">#&gt;  [9] BiocGenerics_0.42.0         MatrixGenerics_1.8.0       </span>
<span class="co">#&gt; [11] matrixStats_0.62.0          BiocStyle_2.24.0           </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;   [1] circlize_0.4.15        systemfonts_1.0.4      plyr_1.8.7            </span>
<span class="co">#&gt;   [4] lazyeval_0.2.2         sp_1.4-7               splines_4.2.0         </span>
<span class="co">#&gt;   [7] crosstalk_1.2.0        ggplot2_3.3.6          elsa_1.1-28           </span>
<span class="co">#&gt;  [10] digest_0.6.29          foreach_1.5.2          htmltools_0.5.2       </span>
<span class="co">#&gt;  [13] fansi_1.0.3            magrittr_2.0.3         memoise_2.0.1         </span>
<span class="co">#&gt;  [16] cluster_2.1.3          tensor_1.5             doParallel_1.0.17     </span>
<span class="co">#&gt;  [19] tzdb_0.3.0             tripack_1.3-9.1        ComplexHeatmap_2.12.0 </span>
<span class="co">#&gt;  [22] R.utils_2.11.0         vroom_1.5.7            pkgdown_2.0.3         </span>
<span class="co">#&gt;  [25] spatstat.sparse_2.1-1  colorspace_2.0-3       ggrepel_0.9.1         </span>
<span class="co">#&gt;  [28] textshaping_0.3.6      xfun_0.31              dplyr_1.0.9           </span>
<span class="co">#&gt;  [31] rgdal_1.5-32           crayon_1.5.1           RCurl_1.98-1.6        </span>
<span class="co">#&gt;  [34] jsonlite_1.8.0         spatstat.data_2.2-0    iterators_1.0.14      </span>
<span class="co">#&gt;  [37] glue_1.6.2             polyclip_1.10-0        gtable_0.3.0          </span>
<span class="co">#&gt;  [40] zlibbioc_1.42.0        XVector_0.36.0         GetoptLong_1.0.5      </span>
<span class="co">#&gt;  [43] DelayedArray_0.22.0    shape_1.4.6            apcluster_1.4.9       </span>
<span class="co">#&gt;  [46] abind_1.4-5            scales_1.2.0           sgeostat_1.0-27       </span>
<span class="co">#&gt;  [49] pheatmap_1.0.12        spatstat.random_2.2-0  Rcpp_1.0.8.3          </span>
<span class="co">#&gt;  [52] viridisLite_0.4.0      clue_0.3-60            spatstat.core_2.4-4   </span>
<span class="co">#&gt;  [55] bit_4.0.4              dittoSeq_1.8.0         htmlwidgets_1.5.4     </span>
<span class="co">#&gt;  [58] httr_1.4.3             RColorBrewer_1.1-3     ellipsis_0.3.2        </span>
<span class="co">#&gt;  [61] pkgconfig_2.0.3        R.methodsS3_1.8.1      farver_2.1.0          </span>
<span class="co">#&gt;  [64] sass_0.4.1             deldir_1.0-6           alphahull_2.4         </span>
<span class="co">#&gt;  [67] utf8_1.2.2             tidyselect_1.1.2       labeling_0.4.2        </span>
<span class="co">#&gt;  [70] rlang_1.0.2            reshape2_1.4.4         munsell_0.5.0         </span>
<span class="co">#&gt;  [73] tools_4.2.0            cachem_1.0.6           cli_3.3.0             </span>
<span class="co">#&gt;  [76] dbscan_1.1-10          generics_0.1.2         splancs_2.01-43       </span>
<span class="co">#&gt;  [79] mmand_1.6.1            ggridges_0.5.3         evaluate_0.15         </span>
<span class="co">#&gt;  [82] stringr_1.4.0          fastmap_1.1.0          yaml_2.3.5            </span>
<span class="co">#&gt;  [85] ragg_1.2.2             goftest_1.2-3          knitr_1.39            </span>
<span class="co">#&gt;  [88] bit64_4.0.5            fs_1.5.2               purrr_0.3.4           </span>
<span class="co">#&gt;  [91] RANN_2.6.1             nlme_3.1-157           R.oo_1.24.0           </span>
<span class="co">#&gt;  [94] pracma_2.3.8           compiler_4.2.0         plotly_4.10.0         </span>
<span class="co">#&gt;  [97] png_0.1-7              spatstat.utils_2.3-1   tibble_3.1.7          </span>
<span class="co">#&gt; [100] bslib_0.3.1            stringi_1.7.6          highr_0.9             </span>
<span class="co">#&gt; [103] desc_1.4.1             lattice_0.20-45        Matrix_1.4-1          </span>
<span class="co">#&gt; [106] vctrs_0.4.1            pillar_1.7.0           lifecycle_1.0.1       </span>
<span class="co">#&gt; [109] BiocManager_1.30.18    spatstat.geom_2.4-0    jquerylib_0.1.4       </span>
<span class="co">#&gt; [112] GlobalOptions_0.1.2    data.table_1.14.2      cowplot_1.1.1         </span>
<span class="co">#&gt; [115] bitops_1.0-7           raster_3.5-15          R6_2.5.1              </span>
<span class="co">#&gt; [118] bookdown_0.26          gridExtra_2.3          codetools_0.2-18      </span>
<span class="co">#&gt; [121] gtools_3.9.2.1         rjson_0.2.21           rprojroot_2.0.3       </span>
<span class="co">#&gt; [124] GenomeInfoDbData_1.2.8 mgcv_1.8-40            parallel_4.2.0        </span>
<span class="co">#&gt; [127] terra_1.5-21           grid_4.2.0             rpart_4.1.16          </span>
<span class="co">#&gt; [130] tidyr_1.2.0            rmarkdown_2.14         Rtsne_0.16</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="author-contributions">Author Contributions<a class="anchor" aria-label="anchor" href="#author-contributions"></a>
</h2>
<p>AT, YF, TY, ML, JZ, VO, MD are authors of the package code. MD and YF wrote the vignette. AT, YF and TY designed the package.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-keren2018structured">
<p>Keren, Leeat, Marc Bosse, Diana Marquez, Roshan Angoshtari, Samir Jain, Sushama Varma, Soo-Ryum Yang, et al. 2018. “A Structured Tumor-Immune Microenvironment in Triple Negative Breast Cancer Revealed by Multiplexed Ion Beam Imaging.” <em>Cell</em> 174 (6): 1373–87.</p>
</div>
<div id="ref-alphahull">
<p>Pateiro-Lopez, Beatriz, Alberto Rodriguez-Casal, and. 2019. <em>Alphahull: Generalization of the Convex Hull of a Sample of Points in the Plane</em>. <a href="https://CRAN.R-project.org/package=alphahull" class="external-link">https://CRAN.R-project.org/package=alphahull</a>.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Anna Trigos, Yuzhou Feng, Tianpei Yang, Mabel Li, John Zhu, Volkan Ozcoban, Maria Doyle.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
