---
title: "Overview of the SPIAT package"
author: "Anna Trigos, Tom Yang, Yuzhou Feng, Volkan Ozcoban"
date: "`r BiocStyle::doc_date()`"
package: SPIAT
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: "`r file.path(system.file(package='SPIAT', 'vignettes'), 'introduction.bib')`"    
vignette: >
  %\VignetteIndexEntry{Overview of the SPIAT package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

SPIAT (**Sp**atial **I**mage **A**nalysis of **T**issues) is an R package with a suite of data processing, quality control, visualization, data handling and data analysis tools [@yang2020spiat]. SPIAT is directly compatible with Opal multiplex immunohistochemistry images analysed through the HALO and InForm analysis software, but its intuitive implementation allows use with a diversity of platforms.

The Opal multiplex immunohistochemistry staining protocol enables 6-8 tissue markers to be used simultaneously on a single slide. It is suitable for use with formalin fixed paraffin embedded (FFPE) tissue sections, so it is also of relevance for clinical practice. The fluorescence of each marker is measured through imaging, and each cell is assigned an X,Y coordinate of its location. In effect this provides single-cell resolution. The fluorescence intensity of individual markers are then combined to yield the location of the cells and their phenotype in the tissue.

SPIAT includes novel algorithms for the identification of cell clusters, cell margins and cell gradients, the calculation of neighbourhood proportions, and algorithms for the prediction of cell phenotypes in tissue images. SPIAT also includes speedy implementations of the calculation of cell distances and detection of cell communities. An overview of the functions available is shown in the figure below. 

<img width="600" alt="overview" src="https://www.biorxiv.org/content/biorxiv/early/2020/05/30/2020.05.28.122614/F1.large.jpg"/>

# Setting up the data

First we load the SPIAT library.

```{r message=FALSE}
# load library
library(SPIAT)
```


We can use `format_image_to_sce` to format raw data for SPIAT, as shown in the commented out code below. `format_image_to_sce` creates a SingleCellExperiment object. It requires 3 things:

- path to the raw InForm or HALO image data file
- names of the markers used in the OPAL staining
- names of the intensity columns of interest

Images must have been cell segmented and cells phenotyped using HALO or InForm software, although SPIAT offers the option of calling phenotypes based on marker levels and marker combinations. See Predicting phenotypes section.

```{r eval=FALSE}
# raw_inform_data <- "S6_[49209,17530]_cell_seg_data.txt"

# markers <- c("DAPI","CD3","PDL1","CD4","CD8","AMACR")

# intensity_columns_interest <- c(
  "Nucleus DAPI (DAPI) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD3 (Opal 520) Mean (Normalized Counts, Total Weighting)", 
  "Membrane PDL-1 (Opal 540) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD4 (Opal 620) Mean (Normalized Counts, Total Weighting)",
  "Cytoplasm CD8 (Opal 650) Mean (Normalized Counts, Total Weighting)", 
  "Cytoplasm AMACR (Opal 690) Mean (Normalized Counts, Total Weighting)"
  )

# formatted_image <- format_image_to_sce(
#                           format="INFORM",
#                           image=raw_inform_data,
#                           markers=markers,
#                           intensity_columns_interest=intensity_columns_interest,
#                           dye_columns_interest=NULL
)
```


In this vignette we will use data that's already formatted for SPIAT, `formatted_image` which we can load with `data`.
```{r}
data("formatted_image")
```

This is *SingleCellExperiment* format where here `assay` stores the intensity level of every marker (rows) for every cell (columns), and `colData` stores the cell properties: phenotype, x and y coordinates, cell size, nucleus size, nucleus compactness, nucleus axis ratio, and cell axis ratio.

```{r}
assay(formatted_image)[1:5, 1:5]
```

```{r}
colData(formatted_image)[1:5,]
```

## Splitting images

In the case of large images, or images where there are two independent tissue sections, it is recommended to split images into sections defined by the user. This can be performed with `image_splitter`. It can also plot the different combinations of markers within the image segments.

```{r}
split_image <- image_splitter(formatted_image, number_of_splits=3, plot = FALSE)
```

# Quality control

We can check what phenotypes are present in the image data with `print_phenotypes`. 

```{r}
print_phenotypes(formatted_image)
```

These phenotypes are determined from individual markers like AMACR or combinations of markers like CD3 and CD4. The phenotypes in this example data can be interpreted as follows: 

AMACR = prostate cancer cells  
CD3,CD4 = helper T cells  
CD3,CD8 = cytotoxic T cells  
PDL1 = immune checkpoint cells

AMACR identifies which cells in the image are prostate cancer cells. CD3,CD4 and CD3,CD8 which types of T cells (immune cells) are present, and PDL1 is used to help determine if the cancer may benefit from immunotherapy treatment.


## Cell proportions/percentages

We can obtain the number and proportion of each cell phenotype with `calculate_cell_proportions`.

```{r}
p_cells <- calculate_cell_proportions(formatted_image)
p_cells
```
To visualize the phenotype proportions as barplots we can use `plot_cell_percentages`.

```{r}
plot_cell_percentages(p_cells)
```

These tell us that in this image the vast majority of cells are tumour cells (AMACR) with some immune cells (CD3,CD4 and CD3,CD8) and very little PDL1 cells. 

We may see incorrect phenotypes present in the input data. For example, cells might be incorrectly assigned a phenotype such as "AMACR,CD3", both a tumour cell (AMACR) and an immune cell phenotype (CD3), which is biologically implausible. Incorrect cell phenotypes may be present due to low cell segmentation quality, antibody ‘bleeding’ from one cell to another or inadequate marker thresholding.

We can use `marker_permutation` to help identify if incorrect cell phenotypes are present. This permutes the marker labels of cells to create a null distribution, and then calculates the empirical p-value of whether an image is enriched or depleted in a particular combination of markers. However, it is not absolute and it is recommended to review the results.

```{r}
# permute marker labels of cells
sig <- marker_permutation(formatted_image, num_iter = 100)

# sort by Observed_cell_number
sig.sorted <- sig[order(-sig$Observed_cell_number), ]

# take a look
head(sig.sorted)
```

If you identify incorrect phenotypes or have any you want to exclude you ca do that with `select_phenotypes`. 

```{r}
data_subset <- select_phenotypes(formatted_image, keep=TRUE,
                                     phenotypes = c("AMACR",
                                                    "CD3,CD8",
                                                    "PDL1"))
print_phenotypes(data_subset)
```

In this vignette we will work with all the original phenotypes present in `formatted_image`.


## Boxplots

Incorrect or unreliable phenotyping of cells may also be identified through comparing the marker level for cells labelled positive and negative for a marker. Cells positive for a marker should have high levels of the marker. An unclear separation of marker intensities between positive and negative cells would suggest phenotypes have not been accurately assigned. We can use `marker_intensity_boxplot` to produce a boxplot for cells phenotyped as being positive or negative for a marker.


```{r}
marker_intensity_boxplot(formatted_image, "CD3")
```

The separation of positive versus negative here suggests the phenotyping for CD3 is adequate. Note that some negative cells will have high marker intensity, and vice versa. This is because HALO and InForm use machine learning to determine positive cells, and not a strict threshold, and also take into account properties such as cell shape, nucleus size etc.

## Scatter plots

Uneven marker staining or high background intensity can be identified with `plot_cell_marker_levels`. This produces a scatter plot of the intensity of a marker in each cell. Cells that were not phenotyped as being positive for the particular marker are excluded.

```{r}
plot_cell_marker_levels(formatted_image, "CD3")
```

## Heatmaps

For large images, there is also the option of ‘blurring’ the image, where the image is split into multiple small areas, and marker intensities are averaged within each. The image is blurred based on the `num_splits` parameter.

```{r}
plot_marker_level_heatmap(formatted_image, num_splits = 100, "AMACR")
```

# Visualizing tissues

In addition to the marker level tissue plots for QC, SPIAT has other methods for visualising markers and phenotypes in tissues.


## 3D surface plot

We can visualize a selected marker in 3D with `marker_surface_plot`. The image is blurred based on the `num_splits` parameter.

```{r}
marker_surface_plot(formatted_image, num_splits=15, marker="CD3")
```

## 3D stacked surface plot

To visualise multiple markers in 3D in a single plot we can use `marker_surface_plot_stack`. This shows normalized intensity level of specified markers and allows the identification of co-occurring and mutually exclusive markers. 

```{r}
marker_surface_plot_stack(formatted_image, num_splits=15, markers=c("AMACR", "CD3"))
```

The stacked surface plots of the AMACR (prostate cancer cell) and CD3 (T cell) markers in this prostate tissue shows how AMACR and CD3 are mutually exclusive as the peaks and valleys are opposite.

## Categorical dot plot

We can see the location of all phenotypes in the tissue with `plot_cell_categories`. Each dot in the plot corresponds to a cell and cells are coloured by phenotype. We can choose the colours for the phenotypes. Any phenotypes present in the data but not in the phenotypes of interest will be put in the category "OTHER" and coloured lightgrey.

```{r}
phenotypes_of_interest <- c("AMACR", "CD3,CD8", "PDL1")
colour_vector <- c("darkgrey", "blue", "red")
plot_cell_categories(formatted_image, phenotypes_of_interest, colour_vector)
```


# Gradients of cells

To determine whether two cell types are interacting with another, or if there is repulsion between them, SPIAT uses the concept of gradients. The assumption is that, if marker A intensity is high close to cells of marker B, and this value decreases as the distance from B increases, it suggests the cells are close and interacting. Conversely, if we see that marker A intensity is low when close to cells of marker B but increases with distance, it suggests there is repulsion between the two cell types. We calculate the marker level within a specified radius with `average_marker_intensity_within_radius` and visualize with `plot_average_intensity`. 

`average_marker_intensity_within_radius` calculates the average intensity of the target_marker within a radius from the cells positive for the reference marker. Note that it pools all cells with the target marker that are within the specific radius of any reference cell. Results represent the average intensities within a radius, but do not correspond to metrics for each cell.

```{r}
average_marker_intensity_within_radius(formatted_image,
                                        reference_marker ="CD8",
                                        target_marker = "CD4",
                                        radius=30)
```

`plot_average_intensity` calculates the average intensity of a target marker for a number of user-supplied radii values. It plots the intensity level at each specified radius as a line graph.

```{r}
plot_average_intensity(formatted_image, reference_marker="CD8", target_marker="CD4", c(30, 35, 40, 45, 50, 75, 100))
```

This plot shows that high levels of CD8 were observed in cells near CD4+ cells and these levels decreased at larger radii. This suggests CD4+ and CD8+ cells may be closely interacting in this tissue.


# Distances between phenotypes

We can calculate the distances between two phenotypes (phenotype A and phenotype B) by identifying the closest cell of phenotype B to each of the cells of phenotype A with `calculate_all_distances_between_phenotypes`.

```{r}
distances <- calculate_all_distances_between_phenotypes(formatted_image, remove_other = TRUE, cell_phenotypes_of_interest = c("CD3,CD4", "CD3,CD8"))
```

This creates a distribution of minimum distances between phenotypes A and B, which can be visualized as a violin plot with `plot_cell_distances_violin`. Visualization of this distribution often reveals whether pairs of cells are evenly spaced across the image, or whether there are clusters of pairs of phenotypes. 

```{r}
plot_cell_distances_violin(distances)
```

From this plot we can see that CD3,CD4 cells seem to be more closely interacting with each other, as there are shorter distances between those cells, than between CD3,CD8 cells or between CD3,CD4 and CD3,CD8 cells.

We can also calculate summary statistics for the distances between each combination of phenotypes, the mean, median and standard deviation, with `calculate_summary_distances_between_phenotypes`.

```{r}
summary_distances <- calculate_summary_distances_between_phenotypes(formatted_image)
```

These cell distances can then be visualized as a heatmap with `plot_distance_heatmap`.

```{r}
plot_distance_heatmap(summary_distances)
```

This plot shows that AMACR cells are interacting most closely with CD3,CD4, followed by CD3,CD8, while PDL1 cells are more distant.

# Cell mixing score

With SPIAT we can quantify how much two cell types are interacting through calculating a cell mixing score. This score was originally defined as the number of immune-tumor interactions divided by the number of immune-immune interactions [@keren2018structured]. SPIAT generalizes this method to allow calculation of any two cell phenotypes. `compute_mixing_score` returns the mixing score between a reference marker and a target marker. This mixing score is defined as the number of target-reference interactions/number of reference-reference interactions within a specified radius.

```{r}
compute_mixing_score(formatted_image, reference_marker = "CD4", target_marker = "CD8")
```

# Bordering cells

If we want to identify cells separating two distinct tissue areas, for example, cells at the tumour margin or at the border of tumour and stroma, we can use `identify_bordering_cells`. The algorithm is explained in the SPIAT paper [@yang2020spiat]. These bordering cells can then be used as a reference cell type for calculation of distances to other cell types. Here we use tumour cells (AMACR) as the reference to identify the bordering cells but any cell type can be used.

```{r}
identify_bordering_cells(formatted_image, reference_marker = "AMACR",
                         rm_noise_radius = 50, radius = 100, lower_bound = 0.05,
                         upper_bound=0.7)
```

# Cell properties

We can use `measure_association_to_cell_properties` to compare two phenotypes for a property, such as Cell.Size, Nucleus.Size, Nucleus.Compactness, Nucleus.Axis.Ratio, Cell.Axis.Ratio. Method options are density plot, boxplot, t test or wilcoxon test. 

```{r}
# boxplot
measure_association_to_cell_properties(formatted_image, 
                                       phenotypes = c("CD3,CD4", "CD3,CD8"),
                                       property = "Cell.Size",
                                       method = "box")
# t test
measure_association_to_cell_properties(formatted_image, 
                                       phenotypes = c("CD3,CD4", "CD3,CD8"),
                                       property = "Cell.Size",
                                       method = "t")
```

# Clusters and communities

We can determine if there are aggregates (or a lack of aggregates) of a particular phenotype or combination of phenotypes. SPIAT can be used to identify two types of cell aggregates, clusters and communities. 

Clusters are cell aggregates composed of non-tumour cells, often by immune cells. For the detection of clusters, `identify_cell_clusters` only considers cell phenotypes of interest defined by the user. Euclidean distances between cells are calculated, and pairs of cells with a distance less than a threshold are considered to be ‘interacting’, with the rest being ‘non-interacting’. Hierarchical clustering is then used to separate the clusters. We need to specify a radius. The radius corresponds to how lenient we are in defining clusters. A bigger radius would mean we are more likely to merge individual clusters. The radius is chosen based on what looks ‘reasonable’. Cells not assigned to clusters ("free" cells) are assigned to Cluster_NA in the output table.

```{r}
clusters <- identify_cell_clusters(formatted_image, phenotypes_of_interest = c("CD3,CD4", "CD3,CD8"), radius = 100)
```

This plot shows clusters of CD3+CD4+ and CD3+CD8+ cells. Each number and colour corresponds to a distinct cluster. Black cells correspond to ‘free’, un-clustered cells. 

Users are recommended to test out different thresholds and then visualise the clustering results. But SPIAT also has `average_minimum_distance`, which calculates the average minimum distance between all cells in an image, and can be used as a starting point.

```{r}
average_minimum_distance(formatted_image)
```

Communities correspond to micro-niches or micro-ecosystems of cells that are geographically located close to each other [@jackson2020single]. The main distinction between clusters and communities is that the algorithm for the detection of communities used by `identify_cell_communities` does not take into account cell phenotype. Therefore, communities often consist of a combination of different cell types, including tumour cells. *dbscan* is used as the clustering algorithm to detect communities [@hahsler2019dbscan]. Cells without a phenotype are excluded.

```{r}
communities <- identify_cell_communities(formatted_image, radius=100)
```

This plot shows communities of cells in the tissue. Each number and colour corresponds to a distinct community. 

We can visualize the cell composition of clusters or communities. This allows us to determine whether there are regions where cells of different types are interacting, or whether there is little mixing between celltypes. To do this, we can use `composition_of_clusters_and_communities` to obtain the percentages of cells with a specific marker within each cluster and the number of cells in the cluster.

```{r}
clusters_vis <- composition_of_clusters_and_communities(clusters, "Cluster")
clusters_vis <- clusters_vis[clusters_vis$Total_number_of_cells >=5,]
```

Then we can use `plot_composition_heatmap` to produce a heatmap showing the marker percentages within each cluster.

```{r}
plot_composition_heatmap(clusters_vis, column_to_consider="Cluster")
```

This plot shows that most clusters are composed of a mixture of CD3+CD4+ and CD3+CD8+ cells and some are more dominated by CD3+CD4+ than others.  

We can visualise the composition of the communities in a similiar way.

```{r}
communities_vis <- composition_of_clusters_and_communities(communities, "Community")
plot_composition_heatmap(communities_vis, column_to_consider="Community")
```

This plot shows that several communities detected have a combination of tumour (AMACR+) and immune cells while some are dominated by tumour or immune cells.


# Neighbourhood proportions

We can characterise cell aggregation in another way, through calculation of the neighbourhood proportion with `percentage_of_cells_within_radius`. Here, we define the proportion of a target cell type within the neighbourhood of a reference cell type within a defined radius. Cells with high neighbourhood proportions of the target cell type can indicate spatial sturctures.  `percentage_of_cells_within_radius` can be used for the detection of gradients instead of `average_marker_intensity_within_radius`, however we recommend using the latter as it is faster, and it uses marker intensities so does not depend on cell phenotyping. The calculation is performed for each reference cell, so runtime will depend on the number of reference cells present.

```{r}
percentage_of_cells_within_radius(formatted_image, reference_phenotypes = "PDL1", target_phenotypes = "AMACR", radius=100)
```

# Predicting phenotypes

Cell phenotyping is often a time-consuming manual process. SPIAT has implemented a method for the automatic phenotyping of cells based on marker intensities. `predict_phenotypes` produces a density plot that shows the actual and predicted cutoff for calling a cell positive for a marker. It also prints to the console the number of true positives (TP), true negatives (TN), false positives (FP) and false negatives (FN) for the prediction. It returns a table containing the predicted intensity status for a particular marker.

```{r}
predicted_image <- predict_phenotypes(formatted_image,
                                      plot_actual_cutoff = TRUE,
                                      plot_predicted_cutoff = TRUE,
                                      thresholds = NULL,
                                      tumour_marker = "AMACR",
                                      baseline_markers = c("CD3", "CD4", "CD8"))
```

We can use `marker_prediction_plot` to plot the predicted cell phenotypes and the ones obtained using HALO or InForm, for comparison. Of note, this algorithm does not take into account cell shape or size, so if these are required for phenotyping, manual phenotyping with HALO or InForm is recommended.

```{r}
marker_prediction_plot(predicted_image, marker="CD3")
```

The plot shows CD3+ cells in the tissue. On the left are the CD3+ cells defined by InForm and on the right are the CD3+ cells predicted using SPIAT.


# Reproducibility

```{r}
sessionInfo()
```


# References
